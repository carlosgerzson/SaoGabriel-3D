<!DOCTYPE html>
<html lang="pt-br">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.133/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.133/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <title>São Gabriel-3D</title>
    <style type="text/css">
        body,
        html {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        #cesiumContainer {
            width: 100% !important;
            height: 100% !important;
        }

        .img-prefeito {
            width: 300px;
            height: 400px;
            object-fit: cover;
            border-radius: 6px;
            display: block;
            margin: 0 auto;
        }

        .img-lenda {
            width: 300px;
            height: 200px;
            object-fit: cover;
            border-radius: 6px;
            display: block;
            margin: 0 auto;
        }

        .img-building {
            width: 300px;
            height: 300px;
            object-fit: cover;
            border-radius: 6px;
            display: block;
            margin: 0 auto;
        }

        /* Esconder o rodapé/credit do Cesium em telas pequenas (mobile) para evitar quebra de layout */
        @media (max-width: 600px) {

            /* O widget de crédito do Cesium contém links; selecionamos por seletor genérico e por href */
            .cesium-viewer-bottom,
            .cesium-viewer .cesium-credit {
                display: none !important;
            }

            /* alternativa mais específica: esconder apenas links para cesium.com, se existirem */
            a[href*="cesium.com"] {
                display: none !important;
            }
        }

        /* Esconder botões / widgets no topo direito do Cesium (desktop e mobile) */
        /* Isto remove: pesquisa (geocoder), Home, SceneMode (plane/curve), e botão de ajuda (interrogação) */
        .cesium-viewer .cesium-viewer-toolbar,
        .cesium-geocoder-container,
        .cesium-geocoder,
        .cesium-viewer .cesium-sceneModePicker,
        .cesium-sceneModePicker,
        .cesium-viewer .cesium-navigationHelpButton,
        .cesium-navigationHelpButton,
        .cesium-viewer .cesium-homeButton,
        .cesium-homeButton,
        /* seletores alternativos por atributo/title (fallback) */
        .cesium-viewer .cesium-button[title*="Home"],
        .cesium-viewer .cesium-button[title*="Search"],
        .cesium-viewer .cesium-button[title*="Help"] {
            display: none !important;
        }

        /* Responsivo: Model-viewer modal em mobile */
        @media (max-width: 768px) {
            #mv-modal {
                width: 95vw !important;
                height: 80vh !important;
                max-width: 95vw !important;
                max-height: 80vh !important;
            }
        }
    </style>
</head>

<body>
    <div id="cesiumContainer"></div>


    <!-- Painel lateral agrupando os botões de controle -->
    <div id="left-panel" style="position:fixed;top:45px;left:5px;z-index:2;display:flex;flex-direction:column;gap:8px;">
        <!-- Botão 'Menu' controla a visibilidade dos controles abaixo (rótulos simplificados) -->
        <button id="todos-btn" aria-expanded="true"
            style="background:#333;color:#f5f5f5;border:1px solid #888;padding:6px 10px;border-radius:6px;font-weight:600;">Menu ▾</button>
        <div id="left-controls" style="display:flex;flex-direction:column;gap:8px;overflow:hidden;transition:max-height 0.28s ease;">
            <button id="toggle-osm-btn" aria-pressed="true" style="background:#292929;color:#f5f5f5;border:1px solid #888;padding:6px 10px;border-radius:6px;">Polígonos</button>
            <button id="toggle-base-btn" style="background:#292929;color:#f5f5f5;border:1px solid #888;padding:6px 10px;border-radius:6px;">Satélite/Urbano</button>
            <!-- Seletor de basemap (limpo, sem título) -->
            <select id="urban-basemap" style="background:#222;color:#fff;border:1px solid #444;padding:6px 10px;border-radius:6px;font-size:13px;">
                <option value="osm">OpenStreetMap</option>
                <option value="maptiler">MapTiler</option>
            </select>
            <button id="tourism-toggle-btn" style="background:#292929;color:#f5f5f5;border:1px solid #888;padding:6px 10px;border-radius:6px;">Turismo (8)</button>
            <button id="marechais-btn" style="background:#333;color:#f5f5f5;border:1px solid #888;padding:6px 10px;border-radius:6px;">Marechais</button>
            <button id="lendas-toggle-btn" style="background:#292929;color:#f5f5f5;border:1px solid #888;padding:6px 10px;border-radius:6px;">Lendas (5)</button>
            <button id="monuments-toggle-btn" style="background:#333;color:#f5f5f5;border:1px solid #888;padding:6px 10px;border-radius:6px;">Monumentos (3)</button>
            <button id="ilustres-btn" style="background: #292929;color:#f5f5f5;border:1px solid #888;padding:6px 10px;border-radius:6px;">Homens Ilustres</button>
            <button id="reset-zoom-btn" title="Centralizar Praça" aria-label="Centralizar Praça" style="background:#5d0606;color:#f5f5f5;border:1px solid #888;padding:6px 10px;border-radius:6px;">Centralizar Praça</button>
        </div>
    </div>

    <!-- Indicador discreto de versão -->
    <div id="version-test" style="position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);z-index:9999;color:#ff0000;font-size:20px;font-weight:bold;opacity:0.8;text-shadow:2px 2px 4px rgba(0,0,0,0.9);pointer-events:none;">
        v103
    </div>

    <script type="module">

        console.log('Script carregado - index-osm-full');

        import { buildingsMap } from './buildingsData.js';
        import { lendas } from './lendasData.js';
        import { prefeitos } from './prefeitosData.js';
        import { marechaisData } from './marechaisData.js';
        import { tourismPoints } from './tourismData.js';
        import { ilustres } from './ilustresData.js';


        // Função para adicionar um mapa histórico como plano
        function addMapaHistorico(viewer, url, largura_m = 300) {
            const proporcao = 2048 / 1380;
            const altura_m = largura_m / proporcao;
            // Conversão metros para graus
            const largura_graus = largura_m / 92000;
            const altura_graus = altura_m / 111000;
            const centerLon = -54.316974;
            const centerLat = -30.340808;
            const rectangle = Cesium.Rectangle.fromDegrees(
                centerLon - largura_graus / 2,
                centerLat - altura_graus / 2,
                centerLon + largura_graus / 2,
                centerLat + altura_graus / 2
            );
            return viewer.entities.add({
                name: url,
                rectangle: {
                    coordinates: rectangle,
                    material: url,
                    height: 35, // elevação acima das OSM/GLB
                    heightReference: Cesium.HeightReference.RELATIVE_TO_GROUND,
                    outline: true,
                    outlineColor: Cesium.Color.YELLOW.withAlpha(0.5),
                    fill: true,
                    alpha: 0.85
                }
            });
        }
        let mapaHistoricoAtual = null;
        let mapaHistoricoNome = null;
        function mostrarOuOcultarMapaHistorico(nomeArquivo) {
            // Se já está visível este mapa, oculta
            if (mapaHistoricoAtual && mapaHistoricoNome === nomeArquivo) {
                viewer.entities.remove(mapaHistoricoAtual);
                mapaHistoricoAtual = null;
                mapaHistoricoNome = null;
                return;
            }
            // Se outro mapa está visível, remove
            if (mapaHistoricoAtual) viewer.entities.remove(mapaHistoricoAtual);
            mapaHistoricoAtual = addMapaHistorico(viewer, nomeArquivo);
            mapaHistoricoNome = nomeArquivo;
        }

        let viewer;
        async function init() {
            // cores padrão para caixas (padronizar facilmente aqui)
            const BOX_BG = '#333';
            const BOX_FG = '#f5f5f5';
            const BOX_ALT = '#292929';
            const BTN_BG = '#444';
            // ...existing code...
                try {
                // Defina seu access token do Cesium Ion aqui (substitua o placeholder abaixo)
                // Você pode também salvar o token em localStorage com a chave 'cesiumIonToken'
                // Ex: localStorage.setItem('cesiumIonToken', 'SEU_TOKEN_AQUI');
                try {
                    const _savedIon = localStorage.getItem('cesiumIonToken');
                    if (_savedIon) {
                        Cesium.Ion.defaultAccessToken = _savedIon;
                        console.debug('[DEBUG] Cesium Ion token carregado de localStorage.');
                    } else {
                        // token inserido pelo usuário
                        Cesium.Ion.defaultAccessToken = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiI5NmUwYzg1Zi1lMGI3LTQ4ZmYtYTI4MC04ZjQyYmYwY2Y2NjgiLCJpZCI6MTI5NjcwLCJpYXQiOjE3NTc4NjMzNTR9.ktheFtRHsrg2EOCenwduLGJWJyCKVfAD3q64qdlUzt8';
                        console.debug('[DEBUG] Cesium Ion token aplicado a partir do código.');
                    }
                } catch (e) {
                    console.warn('[WARN] Falha ao ler token Cesium Ion do localStorage', e);
                }

                // Inicializa o visualizador com Cesium World Terrain
                viewer = new Cesium.Viewer('cesiumContainer', {
                    terrain: Cesium.Terrain.fromWorldTerrain(),
                    infoBox: false,
                    selectionIndicator: false,
                    animation: false,
                    timelcnine: false,
                    baseLayerPicker: false,
                });
                // Debug: log inicial do viewer e camadas de imagery
                try { console.debug('[DEBUG] Viewer criado. imageryLayers.length =', viewer && viewer.imageryLayers ? viewer.imageryLayers.length : 'undefined'); } catch (e) { console.warn('[DEBUG] Falha ao logar viewer inicial', e); }

                // Referência para camada urbana adicionada (se alguma)
                let urbanImageryLayer = null;
                // Se não houver nenhuma imagery layer por padrão, criaremos um fallback OSM
                function ensureFallbackImagery() {
                    try {
                        console.debug('[DEBUG] ensureFallbackImagery: viewer.imageryLayers.length =', viewer && viewer.imageryLayers ? viewer.imageryLayers.length : 'undefined');
                        if (viewer.imageryLayers.length === 0) {
                            console.debug('[DEBUG] ensureFallbackImagery: adicionando OSM fallback');
                            const osmFallback = new Cesium.OpenStreetMapImageryProvider({ url: 'https://a.tile.openstreetmap.org/' });
                            viewer.imageryLayers.addImageryProvider(osmFallback);
                            console.debug('[DEBUG] ensureFallbackImagery: adicionado, nova length =', viewer.imageryLayers.length);
                        }
                    } catch (e) {
                        console.warn('Falha ao adicionar fallback OSM:', e);
                    }
                }


                // Controles da câmera
                viewer.scene.screenSpaceCameraController.rotateEventTypes = [Cesium.CameraEventType.LEFT_DRAG];
                viewer.scene.screenSpaceCameraController.zoomEventTypes = [Cesium.CameraEventType.MIDDLE_DRAG, Cesium.CameraEventType.WHEEL, Cesium.CameraEventType.PINCH];
                viewer.scene.screenSpaceCameraController.panEventTypes = [Cesium.CameraEventType.RIGHT_DRAG];

                // Visão global e depois área de interesse (centro da praça)
                const pracaCentro = { lon: -54.316822, lat: -30.344800, altura: 600 };
                viewer.camera.setView({
                    destination: Cesium.Cartesian3.fromDegrees(pracaCentro.lon, pracaCentro.lat, 20000000),
                });
                viewer.camera.flyTo({
                    destination: Cesium.Cartesian3.fromDegrees(pracaCentro.lon, pracaCentro.lat, pracaCentro.altura),
                    orientation: {
                        heading: Cesium.Math.toRadians(0.0),
                        pitch: Cesium.Math.toRadians(-45.0),
                        roll: 0.0
                    },
                    duration: 3.5,
                    easingFunction: Cesium.EasingFunction.QUADRATIC_IN_OUT,
                    complete: function () {
                        // Caixa de boas-vindas DESABILITADA (pedido dos usuários)
                        // Usuário pode abrir manualmente clicando no botão "São Gabriel 3D"
                        // try { showWelcomeBox(); } catch (e) { console.warn('Erro ao mostrar welcome box', e); }
                    }
                });

                // Garante que as sombras estejam ativas
                viewer.shadows = true;

                // (Sem alterações forçadas ao relógio ou iluminação do globo)

                // --- Base imagery switch (Satélite <-> Mapa Urbano - Carto Positron) ---
                // Inicial: Mapa Urbano ativo por padrão. Permitimos apenas alternar ON/OFF do mapa urbano
                let urbanBaseActive = true;
                function setUrbanBase() {
                    try {
                        // adiciona camada urbana por cima das existentes (não remove outras)
                        // remove apenas a camada urbana anterior, se existir
                        if (urbanImageryLayer) {
                            try { viewer.imageryLayers.remove(urbanImageryLayer); } catch (e) { }
                            urbanImageryLayer = null;
                        }
                        const carto = new Cesium.UrlTemplateImageryProvider({
                            url: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
                            subdomains: ['a', 'b', 'c', 'd'],
                            credit: 'Carto Positron'
                        });
                        urbanImageryLayer = viewer.imageryLayers.addImageryProvider(carto);
                        urbanBaseActive = true;
                        const btn = document.getElementById('toggle-base-btn');
                        if (btn) {
                            // usa rótulo simples e amigável
                            btn.innerText = 'Satélite/Urbano';
                            btn.disabled = false;
                        }
                    } catch (e) {
                        console.warn('Erro ao aplicar Carto Positron:', e);
                    }
                }

                function hideUrbanBase() {
                    try {
                        // remove apenas a camada urbana adicionada
                        if (urbanImageryLayer) {
                            try { viewer.imageryLayers.remove(urbanImageryLayer); } catch (e) { }
                            urbanImageryLayer = null;
                        }
                        // se não houver nenhuma outra camada, garante um fallback (OSM)
                        ensureFallbackImagery();
                        urbanBaseActive = false;
                        const btn = document.getElementById('toggle-base-btn');
                        if (btn) {
                            // mantém rótulo simples
                            btn.innerText = 'Satélite/Urbano';
                            btn.disabled = false;
                        }
                    } catch (e) {
                        console.warn('Erro ao ocultar Mapa Urbano:', e);
                    }
                }

                // Inicializa explicitamente a base urbana (OpenStreetMap padrão)
                setUrbanBase();

                // Ativa handler do botão para alternar Mapa Urbano ON/OFF
                const toggleBaseBtn = document.getElementById('toggle-base-btn');
                if (toggleBaseBtn) {
                    toggleBaseBtn.onclick = () => {
                        if (urbanBaseActive) {
                            hideUrbanBase();
                        } else {
                            setUrbanBase();
                        }
                    };
                    // texto inicial já ajustado por setUrbanBase()
                }
                // Estado e estilos atuais para o layer urbano (padrões leves para reduzir branco)
                let urbanProviderStyle = 'osm'; // pode ser: osm | maptiler
                const urbanStyle = {
                    alpha: 1.0,
                    saturation: 0.88,
                    hue: 0.0
                };

                // Cria um ImageryProvider conforme o estilo solicitado
                function createUrbanProvider(styleName) {
                    try {
                        console.debug('[DEBUG] createUrbanProvider(', styleName, ')');
                        switch (styleName) {
                            case 'carto-dark':
                                return new Cesium.UrlTemplateImageryProvider({
                                    url: 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png',
                                    subdomains: ['a', 'b', 'c', 'd'],
                                    credit: 'Carto Dark'
                                });
                            case 'stamen-toner-lite':
                                return new Cesium.UrlTemplateImageryProvider({
                                    url: 'https://stamen-tiles.a.ssl.fastly.net/toner-lite/{z}/{x}/{y}.png',
                                    credit: 'Stamen Toner Lite'
                                });
                            case 'osm':
                                return new Cesium.OpenStreetMapImageryProvider({ url: 'https://a.tile.openstreetmap.org/' });
                            case 'maptiler':
                                // MapTiler raster tiles (requere token). Token fornecido pelo usuário.
                                return new Cesium.UrlTemplateImageryProvider({
                                    url: 'https://api.maptiler.com/maps/streets/{z}/{x}/{y}.png?key=UPIhGua21q5Oraty8VhJ',
                                    credit: 'MapTiler'
                                });
                            case 'carto-light':
                            default:
                                return new Cesium.UrlTemplateImageryProvider({
                                    url: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
                                    subdomains: ['a', 'b', 'c', 'd'],
                                    credit: 'Carto Positron'
                                });
                        }
                    } catch (e) {
                        console.warn('Erro ao criar imagery provider:', e);
                        return new Cesium.OpenStreetMapImageryProvider({ url: 'https://a.tile.openstreetmap.org/' });
                    }
                }

                // Aplica as propriedades ao imagery layer (se existir)
                function applyUrbanStyleToLayer(layer, style) {
                    if (!layer) return;
                    try {
                        if (typeof style.alpha === 'number') layer.alpha = Number(style.alpha);
                        if (typeof style.saturation === 'number') layer.saturation = Number(style.saturation);
                        if (typeof style.hue === 'number') layer.hue = Number(style.hue);
                    } catch (e) {
                        console.warn('Falha ao aplicar estilo urbano:', e);
                    }
                }

                // Controles de estilo removidos - mantemos apenas seleção de basemap

                // Quando criamos a camada urbana, aplicamos estilos e respeitamos o estilo selecionado
                const originalSetUrbanBase = setUrbanBase;
                setUrbanBase = function(selectedStyle) {
                    console.debug('[DEBUG] setUrbanBase called. selectedStyle =', selectedStyle, 'current urbanProviderStyle =', urbanProviderStyle);
                    // permitimos setUrbanBase() sem argumento para manter compatibilidade
                    if (typeof selectedStyle === 'string') urbanProviderStyle = selectedStyle;
                    // remove camada antiga se existir
                    if (urbanImageryLayer) {
                        try { viewer.imageryLayers.remove(urbanImageryLayer); } catch (e) { }
                        urbanImageryLayer = null;
                    }
                    try {
                        const provider = createUrbanProvider(urbanProviderStyle);
                        urbanImageryLayer = viewer.imageryLayers.addImageryProvider(provider);
                        console.debug('[DEBUG] setUrbanBase: urbanImageryLayer adicionado. imageryLayers.length =', viewer.imageryLayers.length, urbanImageryLayer);
                        urbanBaseActive = true;
                        const btn = document.getElementById('toggle-base-btn');
                        if (btn) btn.innerText = 'Satélite/Urbano';
                        // aplica estilo atual ao novo layer (sem UI controls)
                        applyUrbanStyleToLayer(urbanImageryLayer, urbanStyle);
                    } catch (e) {
                        console.warn('Erro ao setar base urbana:', e);
                        ensureFallbackImagery();
                    }
                };

                // Ligação do seletor de basemap no UI
                const basemapSelect = document.getElementById('urban-basemap');
                if (basemapSelect) {
                    // inicializa valor
                    basemapSelect.value = urbanProviderStyle;
                    basemapSelect.onchange = function() {
                        urbanProviderStyle = this.value;
                        // re-cria a camada urbana com o novo provider e reaplica estilos
                        if (urbanBaseActive) setUrbanBase(urbanProviderStyle);
                    };
                }

                // Garantir que a camada urbana inicial use o provider desejado (padrão: 'osm')
                // Isso substitui a camada Carto criada anteriormente no carregamento, sem remover
                // o código Carto do projeto — apenas recria o layer usando o provider selecionado.
                try {
                    setUrbanBase(urbanProviderStyle);
                    try { console.debug('[DEBUG] após setUrbanBase inicial. viewer.imageryLayers.length =', viewer && viewer.imageryLayers ? viewer.imageryLayers.length : 'undefined'); } catch (e) { }
                } catch (e) {
                    console.warn('Falha ao aplicar base urbana inicial:', e);
                }

                // Controles dinâmicos removidos - UI simplificada
                // Botão 'Todos' que expande/colapsa os controles do painel esquerdo
                const todosBtn = document.getElementById('todos-btn');
                const leftControls = document.getElementById('left-controls');
                
                // Estado do menu (inicia RECOLHIDO)
                let menuExpanded = false;
                
                // Função para recolher menu
                function collapseMenu() {
                    if (!leftControls) return;
                    const children = Array.from(leftControls.children);
                    children.forEach(ch => {
                        ch.style.display = 'none';
                    });
                    if (todosBtn) {
                        todosBtn.innerText = 'Menu ▸';
                        todosBtn.setAttribute('aria-expanded', 'false');
                        todosBtn.style.display = ''; // Sempre visível
                    }
                    menuExpanded = false;
                }
                
                // Função para expandir menu
                function expandMenu() {
                    if (!leftControls) return;
                    const children = Array.from(leftControls.children);
                    children.forEach(ch => {
                        ch.style.display = '';
                    });
                    if (todosBtn) {
                        todosBtn.innerText = 'Menu ▾';
                        todosBtn.setAttribute('aria-expanded', 'true');
                    }
                    menuExpanded = true;
                }
                
                // Inicializa RECOLHIDO (executa imediatamente)
                collapseMenu();
                
                // Handler do botão
                if (todosBtn) {
                    todosBtn.onclick = () => {
                        if (menuExpanded) {
                            collapseMenu();
                        } else {
                            expandMenu();
                        }
                    };
                }
                // Botão para refazer o zoom/voo inicial para a praça
                const resetZoomBtn = document.getElementById('reset-zoom-btn');
                if (resetZoomBtn) {
                    resetZoomBtn.onclick = () => {
                        try {
                            // Evita cliques repetidos enquanto a animação acontece
                            resetZoomBtn.disabled = true;
                            resetZoomBtn.style.opacity = '0.6';
                            viewer.camera.flyTo({
                                destination: Cesium.Cartesian3.fromDegrees(pracaCentro.lon, pracaCentro.lat, pracaCentro.altura),
                                orientation: {
                                    heading: Cesium.Math.toRadians(0.0),
                                    pitch: Cesium.Math.toRadians(-45.0),
                                    roll: 0.0
                                },
                                duration: 3.5,
                                easingFunction: Cesium.EasingFunction.QUADRATIC_IN_OUT,
                                complete: function () {
                                    resetZoomBtn.disabled = false;
                                    resetZoomBtn.style.opacity = '';
                                }
                            });
                        } catch (e) {
                            console.warn('Erro ao refazer zoom:', e);
                            resetZoomBtn.disabled = false;
                            resetZoomBtn.style.opacity = '';
                        }
                    };
                }

                // Tourism UI (simplified)
                // Nota: o botão de "Lista Turismo" e seu modal foram removidos —
                // mantemos apenas o toggle de marcadores (tourism-toggle-btn).

                // Função que cria a caixa de boas-vindas centralizada com conteúdo da prefeitura
                // DESABILITADA: removida do menu para simplificar UI (manter comentada para uso futuro)
                /* function showWelcomeBox() {
                    const existing = document.getElementById('welcome-box');
                    if (existing) return; // já visível
                    const box = document.createElement('div');
                    box.id = 'welcome-box';
                    box.style.position = 'fixed';
                    box.style.left = '50%';
                    box.style.top = '50%';
                    box.style.transform = 'translate(-50%,-50%)';
                    box.style.zIndex = 200;
                    box.style.width = '520px';
                    box.style.maxWidth = '95vw';
                    box.style.maxHeight = '70vh';
                    box.style.overflowY = 'auto';
                    box.style.background = BOX_BG;
                    box.style.color = BOX_FG;
                    box.style.padding = '16px';
                    box.style.borderRadius = '10px';
                    box.style.boxShadow = '0 4px 30px rgba(0,0,0,0.4)';
                    box.style.fontFamily = 'sans-serif';
                    box.innerHTML = `
                        <div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;'>
                            <div style='font-size:18px;font-weight:700;color:#f5f5f5;'>São Gabriel 3D</div>
                            <div style='display:flex;gap:8px;align-items:center;'>
                                <button id='welcome-close' style='background:transparent;color:#f5f5f5;border:none;padding:6px 10px;border-radius:6px;cursor:pointer;'>Fechar</button>
                            </div>
                        </div>
                        <div style='font-size:14px;color:#f5f5f5;line-height:1.4;'>
                            <div style='margin-bottom:12px;'>
                                <b>Sobre este aplicativo</b>
                                <p style='margin-top:6px;'>O <b>São Gabriel 3D</b> é uma experiência interativa criada para contar a história da cidade em três dimensões. Reunimos conteúdos históricos, culturais e arquitetônicos por meio de modelos 3D, imagens e descrições para que você possa explorar o patrimônio de forma imersiva.</p>
                            </div>
                            <div style='margin-bottom:12px;'>
                                <b>Objetivo</b>
                                <p style='margin-top:6px;'>Nosso objetivo é reconstruir e documentar a história urbana de São Gabriel em 3D. Novos modelos e conteúdos serão adicionados periodicamente — acompanhe as atualizações. Sua participação (sugestões ou correções) ajuda a melhorar o acervo.</p>
                            </div>
                            <div>
                                <b>Como explorar</b>
                                <ul style='margin-top:6px;margin-left:18px;line-height:1.3;'>
                                    <li>Use o mapa e os controles à esquerda para localizar pontos de interesse.</li>
                                    <li>Clique em prédios e monumentos para abrir infoboxes com imagens, modelos 3D e informações detalhadas.</li>
                                </ul>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(box);
                    document.getElementById('welcome-close').onclick = () => { if (box.parentNode) box.parentNode.removeChild(box); };
                } */

                // Injetar CSS responsivo para mobile (aplica-se especialmente à caixa de boas-vindas e infoboxes)
                (function injectMobileStyles() {
                    const styleId = 'mobile-responsive-styles';
                    if (document.getElementById(styleId)) return;
                    const css = `
                            /* Regras específicas para telefones modernos (iPhone/Android) */
                                        @media (max-width: 420px) {
                                /* Caixa de boas-vindas - ocupa maior altura e largura reduzida */
                                #welcome-box {
                                    left: 50% !important;
                                    top: 6% !important;
                                    transform: translateX(-50%) !important;
                                    width: 94vw !important;
                                    max-width: 94vw !important;
                                    height: 84vh !important;
                                    max-height: 84vh !important;
                                    overflow: auto !important;
                                    padding: 14px !important;
                                    border-radius: 10px !important;
                                    box-shadow: 0 6px 40px rgba(0,0,0,0.6) !important;
                                    z-index: 200 !important;
                                }
                                /* Tornar botões e textos maiores para touch */
                                #welcome-box button, #welcome-box a {
                                    padding: 12px 14px !important;
                                    font-size: 16px !important;
                                    border-radius: 8px !important;
                                }

                                /* Ajuste geral dos infoboxes para layout em coluna e conteúdo rolável */
                                #infobox, #prefeitos-box, #marechais-box, #ilustres-box, #infobox-lenda, #tourism-infobox {
                                    left: 50% !important;
                                    right: auto !important;
                                    top: 6% !important;
                                    transform: translateX(-50%) !important;
                                    width: 94vw !important;
                                    max-width: 94vw !important;
                                    /* Aumenta a altura no mobile para garantir conteúdo legível */
                                    height: 86vh !important;
                                    max-height: 86vh !important;
                                    overflow: hidden !important; /* container principal não rola; conteúdo interno rola */
                                    border-radius: 10px !important;
                                    padding: 14px !important;
                                    box-sizing: border-box !important;
                                    z-index: 200 !important;
                                    display: flex !important;
                                    flex-direction: column !important;
                                }

                                /* Conteúdo interno (primeiro filho) fica rolável; botão de fechar fica fixo na base do container */
                                #infobox > div, #prefeitos-box > div, #marechais-box > div, #ilustres-box > div, #infobox-lenda > div, #tourism-infobox > div {
                                    overflow: auto !important;
                                    flex: 1 1 auto !important;
                                    display: flex !important;
                                    flex-direction: column !important;
                                }

                                /* Garante que as imagens não ocupem espaço excessivo e empurrem o botão para fora */
                                .img-building, .img-prefeito, .img-lenda {
                                    /* aumenta a reserva para imagem, mas limita para não ultrapassar o viewport */
                                    max-height: 40vh !important;
                                    width: auto !important;
                                    object-fit: contain !important;
                                    display: block !important;
                                    margin: 0 auto !important;
                                }

                                /* Botões de ação/fechar ficam visíveis e centralizados na base */
                                #marechais-box button#marechais-close,
                                #ilustres-box button#ilustres-close,
                                #prefeitos-box button#prefeitos-close,
                                #infobox button#close-infobox,
                                #infobox-lenda button#close-infobox-lenda {
                                    align-self: center !important;
                                    margin-top: 12px !important;
                                    flex-shrink: 0 !important;
                                }

                                /* Left-panel stays at top-left on most phones; make controls scrollable vertically
                                   Botões maiores, área limitada para evitar cobrir todo o mapa (rolagem interna) */
                                #left-panel {
                                    left: 8px !important;
                                    right: auto !important;
                                    top: 12px !important;
                                    bottom: auto !important;
                                    display: flex !important;
                                    flex-direction: column !important;
                                    gap: 8px !important;
                                    align-items: flex-start !important;
                                    /* reduzir z-index para ficar atrás das infoboxes (infoboxes usam z ~200) */
                                    z-index: 40 !important;
                                    max-width: 46vw !important; /* ocupa até metade da largura para mobile */
                                }
                                #left-controls {
                                    display: flex !important;
                                    flex-direction: column !important;
                                    gap: 8px !important;
                                    overflow-x: hidden !important;
                                    overflow-y: auto !important;
                                    max-height: 64vh !important; /* limita a área e permite rolagem */
                                    width: 100% !important;
                                    padding: 6px 4px !important;
                                    -webkit-overflow-scrolling: touch !important;
                                }
                                /* botões do painel: largura mínima e padding fixo para evitar compressão/resize ao colapsar */
                                #left-panel button, #left-controls button {
                                    padding: 10px 12px !important;
                                    font-size: 15px !important;
                                    border-radius: 8px !important;
                                    white-space: normal !important; /* permite quebra de linha em labels longas */
                                    text-align: left !important;
                                    min-width: 84px !important;
                                    box-sizing: border-box !important;
                                }
                                /* garantir que o botão 'Todos' mantenha estilo previsível (não encolha) */
                                #todos-btn {
                                    padding: 8px 10px !important;
                                    font-size: 14px !important;
                                    min-width: 88px !important;
                                    box-sizing: border-box !important;
                                }

                                /* transição consistente para expand/collapse */
                                #left-controls {
                                    transition: max-height 0.28s ease !important;
                                }
                            }

                            /* Reforço para telas ainda menores (ex: telefones compactos) */
                            @media (max-width: 420px) {
                                #infobox, #prefeitos-box, #marechais-box, #ilustres-box, #infobox-lenda, #tourism-infobox {
                                    width: 96vw !important;
                                    height: 88vh !important;
                                    padding: 12px !important;
                                }
                                .img-building, .img-prefeito, .img-lenda { max-height: 42vh !important; }
                            }
                        `;
                    const st = document.createElement('style');
                    st.id = styleId;
                    st.appendChild(document.createTextNode(css));
                    document.head.appendChild(st);
                })();

                // Handler do botão 'Sobre o Projeto' removido (função showWelcomeBox comentada)

                // Atacha handler ao botão estático 'Homens Ilustres'
                const ilustresBtn = document.getElementById('ilustres-btn');
                if (ilustresBtn) ilustresBtn.onclick = () => { showIlustresCarousel(); };

                let tourismMarkersVisible = false;
                let tourismEntities = [];
                document.getElementById('tourism-toggle-btn').onclick = () => {
                    tourismMarkersVisible = !tourismMarkersVisible;
                    if (tourismMarkersVisible) addTourismMarkers();
                    else removeTourismMarkers();
                };

                function addTourismMarkers() {
                    if (!viewer) return;
                    removeTourismMarkers();
                    tourismPoints.forEach(p => {
                        // billboard principal (maior)
                        const ent = viewer.entities.add({
                            id: p.id,
                            position: Cesium.Cartesian3.fromDegrees(p.lon, p.lat, 5),
                            billboard: {
                                image: p.icon || 'https://cdn-icons-png.flaticon.com/512/149/149060.png',
                                verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                                heightReference: Cesium.HeightReference.CLAMP_TO_GROUND,
                                width: 48,
                                height: 48
                            },
                            tourismId: p.id
                        });
                        // sombra (ellipse) ligeiramente abaixo do solo
                        const shadow = viewer.entities.add({
                            id: p.id + '_shadow',
                            position: Cesium.Cartesian3.fromDegrees(p.lon, p.lat, 0.5),
                            ellipse: {
                                semiMajorAxis: 6.0,
                                semiMinorAxis: 3.5,
                                material: Cesium.Color.BLACK.withAlpha(0.25),
                                heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                            }
                        });
                        tourismEntities.push(ent);
                        tourismEntities.push(shadow);
                    });
                }

                function removeTourismMarkers() {
                    tourismEntities.forEach(e => viewer.entities.remove(e));
                    tourismEntities = [];
                }

                // showTourismListModal removed — lista de turismo foi eliminada do menu



                // Adiciona marcadores das lendas
                const lendaEntities = [];
                // Estado do toggle de Lendas (botão no menu 'Todos')
                let lendasMarkersVisible = false;
                // Handler do botão de Lendas (adicionado ao menu 'Todos')
                const lendasToggleBtn = document.getElementById('lendas-toggle-btn');
                if (lendasToggleBtn) {
                    lendasToggleBtn.onclick = () => {
                        lendasMarkersVisible = !lendasMarkersVisible;
                        // Alterna visibilidade das entidades já criadas
                        lendaEntities.forEach(ent => {
                            try { ent.show = lendasMarkersVisible; } catch (e) { /* ent pode ser indefinido */ }
                        });
                        // manter o texto fixo em 'Lendas (5)'
                        lendasToggleBtn.innerText = 'Lendas (5)';
                        // Se marcadores devem aparecer, cria-los caso ainda não existam
                        if (lendasMarkersVisible && lendaEntities.length === 0 && typeof lendas !== 'undefined') {
                            lendas.forEach((lenda, idx) => {
                                const entity = viewer.entities.add({
                                    position: Cesium.Cartesian3.fromDegrees(lenda.position.lon, lenda.position.lat, 5),
                                    billboard: {
                                        image: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
                                        width: 40,
                                        height: 40,
                                        verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                                        heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                                    },
                                    lendaId: idx
                                });
                                lendaEntities.push(entity);
                            });
                        }
                    };
                }
                // Marcador para carrossel de prefeitos (sobre a prefeitura)
                const prefeituraData = buildingsMap['494741651'];
                let prefeitosMarker = null;
                if (prefeituraData) {
                    prefeitosMarker = viewer.entities.add({
                        id: 'prefeitura_prefeitos_marker',
                        position: prefeituraData.position,
                        billboard: {
                            image: 'https://cdn-icons-png.flaticon.com/512/1828/1828884.png', // ícone diferente
                            width: 42,
                            height: 42,
                            verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                            heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                        }
                    });
                }

                // Monumentos (IDs finais no buildingsMap) - toggle para destacar/mostrar marcadores
                let monumentsVisible = false;
                const monumentIds = ['111111111', '222222222', '333333333'];
                const monumentEntities = [];
                const monumentsToggleBtn = document.getElementById('monuments-toggle-btn');
                if (monumentsToggleBtn) {
                    monumentsToggleBtn.onclick = () => {
                        monumentsVisible = !monumentsVisible;
                        if (monumentsVisible) {
                            // cria elipses (halo) no solo para cada monumento — mais legível contra o terreno
                            monumentIds.forEach(id => {
                                const data = buildingsMap[id];
                                if (!data || !data.position) return;
                                // elipse principal: halo semi-transparente
                                const halo = viewer.entities.add({
                                    id: 'monument_halo_' + id,
                             position: data.position,
                                    ellipse: {
                                        semiMajorAxis: 12.0,
                                        semiMinorAxis: 8.0,
                                        material: Cesium.Color.fromBytes(255, 200, 0, 160), // amarelo/laranja translúcido
                                        heightReference: Cesium.HeightReference.CLAMP_TO_GROUND,
                                        classificationType: Cesium.ClassificationType.BOTH
                                    }
                                });
                                // sombra/outline: elipse menor e mais escura
                                const edge = viewer.entities.add({
                                    id: 'monument_edge_' + id,
                                    position: data.position,
                                    ellipse: {
                                        semiMajorAxis: 9.0,
                                        semiMinorAxis: 6.0,
                                        material: Cesium.Color.BLACK.withAlpha(0.25),
                                        heightReference: Cesium.HeightReference.CLAMP_TO_GROUND,
                                        classificationType: Cesium.ClassificationType.BOTH
                                    }
                                });
                                monumentEntities.push(halo, edge);
                            });
                            monumentsToggleBtn.innerText = 'Monumentos (3) ✓';
                        } else {
                            // remove halos
                            monumentEntities.forEach(e => viewer.entities.remove(e));
                            monumentEntities.length = 0;
                            monumentsToggleBtn.innerText = 'Monumentos (3)';
                        }
                    };
                }

                // Botão para Marechais (abre carrossel)
                const marechaisBtn = document.createElement('button');
                marechaisBtn.id = 'marechais-btn';
                marechaisBtn.textContent = 'Marechais';
                marechaisBtn.style.position = 'fixed';
                marechaisBtn.style.top = '290px';
                marechaisBtn.style.left = '5px';
                marechaisBtn.style.zIndex = '2';
                marechaisBtn.style.background = '#efe';
                marechaisBtn.style.border = '1px solid #888';
                marechaisBtn.style.padding = '4px 8px';
                marechaisBtn.style.borderRadius = '6px';
                // Atacha handler ao botão estático 'Marechais'
                const marechaisBtnStatic = document.getElementById('marechais-btn');
                if (marechaisBtnStatic) marechaisBtnStatic.onclick = () => { showMarechaisCarousel(); };
                
                // Inversão de sombras removida — sem alterações programáticas na luz da cena.
                // Função para mostrar carrossel/infobox dos Marechais
                function showMarechaisCarousel(startIndex = 0) {
                    if (!marechaisData || !marechaisData.length) return;
                    let idx = Math.min(Math.max(startIndex, 0), marechaisData.length - 1);
                    let oldBox = document.getElementById('marechais-box');
                    if (oldBox) oldBox.parentNode.removeChild(oldBox);
                    let box = document.createElement('div');
                    box.id = 'marechais-box';
                    box.style.position = 'fixed';
                    box.style.top = '50%';
                    box.style.left = '50%';
                    box.style.transform = 'translate(-50%, -50%) scale(0.9)';
                    box.style.setProperty('background', BOX_BG, 'important');
                    box.style.setProperty('color', BOX_FG, 'important');
                    box.style.border = '1.5px solid #aaa';
                    box.style.padding = '14px';
                    box.style.zIndex = 30;
                    box.style.width = '320px';
                    box.style.maxWidth = '90vw';
                    box.style.maxHeight = '85vh';
                    box.style.overflowY = 'auto';
                    box.style.boxShadow = '0 8px 32px rgba(0,0,0,0.6)';
                    box.style.borderRadius = '10px';
                    box.style.fontFamily = 'sans-serif';
                    box.style.opacity = '0';
                    box.style.transition = 'transform 0.4s cubic-bezier(.6,1.5,.4,1), opacity 0.4s';
                    document.body.appendChild(box);
                    window.addEventListener('keydown', keyHandler);
                    function keyHandler(e) {
                        if (box.style.display !== 'block') return;
                        if (e.key === 'ArrowRight') { idx = (idx + 1) % marechaisData.length; render(); }
                        if (e.key === 'ArrowLeft') { idx = (idx - 1 + marechaisData.length) % marechaisData.length; render(); }
                    }
                    function render() {
                        const m = marechaisData[idx];
                        const foto = m.foto ? m.foto : 'placeholder_prefeito.jpg';
                        let zebra = '';
                        if (m.resumo) {
                            let descParts = m.resumo.split(/<br\s*\/?/);
                            zebra = descParts.map((part, i) => `<div style='background:${i % 2 === 0 ? BOX_BG : BOX_ALT};color:${BOX_FG};padding:4px 8px;border-radius:3px;margin-bottom:4px;'>${part}</div>`).join('');
                        }
                        if (m.observacao) {
                            zebra += `<div style='margin-top:6px;'><b>Obs.:</b></div>`;
                            zebra += `<div style='background:${BOX_ALT};color:${BOX_FG};padding:2px 6px;border-radius:3px;'>${m.observacao}</div>`;
                        }
                        box.innerHTML = `
                            <div style='position:relative;padding-top:6px;'>
                                <button id='marechais-close' style='position:absolute;top:6px;right:6px;background:#d33;color:#fff;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:14px;font-weight:bold;'>✕</button>
                            </div>
                            <div style='text-align:center;color:#fff;padding-top:4px;'>
                                <b style='font-size:17px;'>${m.nome}</b><br><br>
                                <img src='${foto}' alt='${m.nome}' class='img-prefeito' style='border:1.5px solid #aaa;background:'+BTN_BG+';'>
                                <div style='margin-top:12px;text-align:left;font-size:15px;'>${zebra}</div>
                                <div style='display:flex;justify-content:space-between;align-items:center;margin-top:12px;'>
                                    <button id='marechais-prev' style='background:'+BTN_BG+';color:'+BOX_FG+';border:1px solid #888;border-radius:4px;padding:2px 12px;cursor:pointer;'>◀</button>
                                    <span style='color:#fff;'>${idx + 1} / ${marechaisData.length}</span>
                                    <button id='marechais-next' style='background:'+BTN_BG+';color:'+BOX_FG+';border:1px solid #888;border-radius:4px;padding:2px 12px;cursor:pointer;'>▶</button>
                                </div>
                            </div>`;
                        document.getElementById('marechais-prev').onclick = () => { idx = (idx - 1 + marechaisData.length) % marechaisData.length; render(); };
                        document.getElementById('marechais-next').onclick = () => { idx = (idx + 1) % marechaisData.length; render(); };
                        document.getElementById('marechais-close').onclick = () => {
                            if (box.parentNode) box.parentNode.removeChild(box);
                            window.removeEventListener('keydown', keyHandler);
                        };
                        setTimeout(() => {
                            box.style.transform = 'translate(-50%, -50%) scale(1)';
                            box.style.opacity = '1';
                        }, 10);
                    }
                    render();
                }

                function showPrefeitosCarousel(startIndex = 0) {
                    if (!prefeitos || !prefeitos.length) return;
                    let idx = Math.min(Math.max(startIndex, 0), prefeitos.length - 1);
                    // Sempre remove o box anterior, se existir, para garantir animação
                    let oldBox = document.getElementById('prefeitos-box');
                    if (oldBox) {
                        oldBox.parentNode.removeChild(oldBox);
                    }
                    let box = document.createElement('div');
                    box.id = 'prefeitos-box';
                    box.style.position = 'fixed';
                    box.style.top = '10px';
                    box.style.right = '20px';
                    box.style.setProperty('background', BOX_BG, 'important');
                    box.style.setProperty('color', BOX_FG, 'important');
                    box.style.border = '1.5px solid #aaa';
                    box.style.padding = '14px';
                    box.style.zIndex = 30;
                    box.style.width = '320px';
                    box.style.boxShadow = '0 2px 16px #000a';
                    box.style.borderRadius = '10px';
                    box.style.fontFamily = 'sans-serif';
                    box.style.transform = 'translateX(380px)';
                    box.style.opacity = '0';
                    box.style.transition = 'transform 0.6s cubic-bezier(.6,1.5,.4,1), opacity 0.4s';
                    document.body.appendChild(box);
                    // Navegação por teclado
                    window.addEventListener('keydown', keyHandler);
                    function keyHandler(e) {
                        if (box.style.display !== 'block') return;
                        if (e.key === 'ArrowRight') { idx = (idx + 1) % prefeitos.length; render(); }
                        if (e.key === 'ArrowLeft') { idx = (idx - 1 + prefeitos.length) % prefeitos.length; render(); }
                    }
                    function render() {
                        const p = prefeitos[idx];
                        const foto = p.foto ? p.foto : 'placeholder_prefeito.jpg';
                        const periodos = (p.periodos && p.periodos.length) ? p.periodos.join('<br>') : '<i>Períodos não informados</i>';
                        // Linhas zebra para períodos e observação
                        let zebra = '';
                        if (p.periodos && p.periodos.length) {
                            zebra += `<div style='margin-bottom:2px;'><b>Período(s):</b></div>`;
                            p.periodos.forEach((per, i) => {
                                zebra += `<div style='background:${i % 2 === 0 ? BOX_BG : BOX_ALT};color:${BOX_FG};padding:2px 6px;border-radius:3px;'>${per}</div>`;
                            });
                        }
                        if (p.observacao) {
                            zebra += `<div style='margin-top:6px;'><b>Obs.:</b></div>`;
                            zebra += `<div style='background:${BOX_ALT};color:${BOX_FG};padding:2px 6px;border-radius:3px;'>${p.observacao}</div>`;
                        }
                        box.innerHTML = `
                            <div style='text-align:center;color:#fff;'>
                                <div style='font-size:20px;font-weight:bold;margin-bottom:8px;color:#fff;'>Prefeitos de São Gabriel</div>
                                <b style='font-size:17px;'>${p.nome}</b><br><br>
                                <img src='${foto}' alt='${p.nome}' class='img-prefeito' style='border:1.5px solid #aaa;background:'+BTN_BG+';'>
                                <div style='margin-top:12px;text-align:left;font-size:15px;'>
                                    ${zebra}
                                </div>
                                <div style='display:flex;justify-content:space-between;margin-top:12px;'>
                                    <button id='prefeitos-prev' style='background:'+BTN_BG+';color:'+BOX_FG+';border:1px solid #888;border-radius:4px;padding:2px 12px;cursor:pointer;'>◀</button>
                                    <span style='color:#fff;'>${idx + 1} / ${prefeitos.length}</span>
                                    <button id='prefeitos-next' style='background:'+BTN_BG+';color:'+BOX_FG+';border:1px solid #888;border-radius:4px;padding:2px 12px;cursor:pointer;'>▶</button>
                                </div>
                                <button id='prefeitos-close' style='margin-top:14px;background:'+BOX_BG+';color:'+BOX_FG+';border:1px solid #888;border-radius:4px;padding:4px 18px;cursor:pointer;'>Fechar</button>
                            </div>`;
                        document.getElementById('prefeitos-prev').onclick = () => { idx = (idx - 1 + prefeitos.length) % prefeitos.length; render(); };
                        document.getElementById('prefeitos-next').onclick = () => { idx = (idx + 1) % prefeitos.length; render(); };
                        document.getElementById('prefeitos-close').onclick = () => {
                            // Remove o box do DOM ao fechar
                            if (box.parentNode) box.parentNode.removeChild(box);
                            window.removeEventListener('keydown', keyHandler);
                        };
                        // Trigger animação de entrada
                        setTimeout(() => {
                            box.style.transform = 'translateX(0)';
                            box.style.opacity = '1';
                            box.style.display = 'block';
                        }, 10);
                    }
                    render();
                }

                // Carrossel para Homens Ilustres (foto + resumo + fonte)
                function showIlustresCarousel(startIndex = 0) {
                    if (!ilustres || !ilustres.length) return;
                    let idx = Math.min(Math.max(startIndex, 0), ilustres.length - 1);
                    let oldBox = document.getElementById('ilustres-box');
                    if (oldBox) oldBox.parentNode.removeChild(oldBox);
                    let box = document.createElement('div');
                    box.id = 'ilustres-box';
                    box.style.position = 'fixed';
                    box.style.top = '50%';
                    box.style.left = '50%';
                    box.style.transform = 'translate(-50%, -50%) scale(0.9)';
                    box.style.setProperty('background', BOX_BG, 'important');
                    box.style.setProperty('color', BOX_FG, 'important');
                    box.style.border = '1.5px solid #aaa';
                    box.style.padding = '14px';
                    box.style.zIndex = 30;
                    box.style.width = '320px';
                    box.style.maxWidth = '90vw';
                    box.style.maxHeight = '85vh';
                    box.style.overflowY = 'auto';
                    box.style.boxShadow = '0 8px 32px rgba(0,0,0,0.6)';
                    box.style.borderRadius = '10px';
                    box.style.fontFamily = 'sans-serif';
                    box.style.opacity = '0';
                    box.style.transition = 'transform 0.4s cubic-bezier(.6,1.5,.4,1), opacity 0.4s';
                    document.body.appendChild(box);

                    function render() {
                        const it = ilustres[idx];
                        const foto = it.foto ? it.foto : 'placeholder_prefeito.jpg';
                        box.innerHTML = `
                            <div style='position:relative;padding-top:6px;'>
                                <button id='ilustres-close' style='position:absolute;top:6px;right:6px;background:#d33;color:#fff;border:none;border-radius:4px;padding:4px 10px;cursor:pointer;font-size:14px;font-weight:bold;'>✕</button>
                            </div>
                            <div style='text-align:center;color:#fff;padding-top:4px;'>
                                <b style='font-size:17px;'>${it.nome}</b><br><br>
                                <img src='${foto}' alt='${it.nome}' class='img-prefeito' style='border:1.5px solid #aaa;background:'+BTN_BG+';'>
                                <div style='margin-top:12px;text-align:left;font-size:14px;color:#ddd;'>${it.resumo}</div>
                                <div style='display:flex;justify-content:space-between;align-items:center;margin-top:12px;'>
                                    <button id='ilustres-prev' style='background:'+BTN_BG+';color:'+BOX_FG+';border:1px solid #888;border-radius:4px;padding:2px 12px;cursor:pointer;'>◀</button>
                                    <span style='color:#fff;'>${idx + 1} / ${ilustres.length}</span>
                                    <button id='ilustres-next' style='background:'+BTN_BG+';color:'+BOX_FG+';border:1px solid #888;border-radius:4px;padding:2px 12px;cursor:pointer;'>▶</button>
                                </div>
                            </div>`;
                        document.getElementById('ilustres-prev').onclick = () => { idx = (idx - 1 + ilustres.length) % ilustres.length; render(); };
                        document.getElementById('ilustres-next').onclick = () => { idx = (idx + 1) % ilustres.length; render(); };
                        document.getElementById('ilustres-close').onclick = () => { if (box.parentNode) box.parentNode.removeChild(box); };
                        setTimeout(() => {
                            box.style.transform = 'translate(-50%, -50%) scale(1)';
                            box.style.opacity = '1';
                        }, 10);
                    }
                    render();
                }
                lendas.forEach((lenda, idx) => {
                    const entity = viewer.entities.add({
                        position: Cesium.Cartesian3.fromDegrees(lenda.position.lon, lenda.position.lat, 5), // 5 metros acima do solo
                        billboard: {
                            image: 'https://cdn-icons-png.flaticon.com/512/684/684908.png',
                            width: 40,
                            height: 40,
                            verticalOrigin: Cesium.VerticalOrigin.BOTTOM,
                            heightReference: Cesium.HeightReference.CLAMP_TO_GROUND
                        },
                        lendaId: idx
                    });
                    lendaEntities.push(entity);
                });

                // Função para mostrar infobox de lenda com carrossel
                function showLendaInfobox(idx) {
                    const lenda = lendas[idx];
                    if (!lenda) return;
                    let oldBox = document.getElementById('infobox-lenda');
                    if (oldBox) oldBox.parentNode.removeChild(oldBox);
                    let box = document.createElement('div');
                    box.id = 'infobox-lenda';
                    box.style.position = 'fixed';
                    box.style.top = '50%';
                    box.style.left = '50%';
                    box.style.transform = 'translate(-50%, -50%) scale(0.9)';
                    box.style.setProperty('background', BOX_BG, 'important');
                    box.style.setProperty('color', BOX_FG, 'important');
                    box.style.border = '1.5px solid #aaa';
                    box.style.padding = '14px';
                    box.style.zIndex = 30;
                    box.style.width = '340px';
                    box.style.maxWidth = '90vw';
                    box.style.maxHeight = '85vh';
                    box.style.boxShadow = '0 8px 32px rgba(0,0,0,0.6)';
                    box.style.borderRadius = '10px';
                    box.style.fontFamily = 'sans-serif';
                    box.style.opacity = '0';
                    box.style.transition = 'transform 0.4s cubic-bezier(.6,1.5,.4,1), opacity 0.4s';
                    box.style.overflowY = 'auto';
                    document.body.appendChild(box);

                    // Zebra para descrição longa
                    let zebraDesc = '';
                    if (lenda.description) {
                        let descParts = lenda.description.split(/<br\s*\/?><br\s*\/?/);
                        zebraDesc = descParts.map((part, i) => `<div style='background:${i % 2 === 0 ? BOX_BG : BOX_ALT};color:${BOX_FG};padding:4px 8px;border-radius:3px;margin-bottom:4px;'>${part}</div>`).join('');
                    }

                    let carousel = '';
                    if (lenda.images && lenda.images.length > 0) {
                        if (lenda.images.length === 1) {
                            carousel = `<div style="text-align:center;"><img id="carousel-img" src="${lenda.images[0]}" class="img-lenda" /></div>`;
                        } else {
                            carousel = `
                            <div id="carousel-lenda" style="text-align:center;">
                                <img id="carousel-img" src="${lenda.images[0]}" class="img-lenda" />
                                <br>
                                <button id="prev-img" style='background:'+BTN_BG+';color:'+BOX_FG+';border:1px solid #888;border-radius:4px;padding:2px 12px;cursor:pointer;'>◀</button>
                                <span id="img-indicator" style='color:${BOX_FG};'>1/${lenda.images.length}</span>
                                <button id="next-img" style='background:'+BTN_BG+';color:'+BOX_FG+';border:1px solid #888;border-radius:4px;padding:2px 12px;cursor:pointer;'>▶</button>
                            </div>`;
                        }
                    }
                    box.innerHTML = `
                        <div style='text-align:center;color:#fff;'>
                            <div style='font-size:20px;font-weight:bold;margin-bottom:8px;color:#fff;'>${lenda.title}</div>
                            ${carousel}
                            <div style='margin-top:12px;text-align:left;font-size:15px;'>${zebraDesc}</div>
                            <div style='margin-top:12px;'><button id='close-infobox-lenda' style='background:'+BOX_BG+';color:'+BOX_FG+';border:1px solid #888;border-radius:4px;padding:4px 18px;cursor:pointer;'>Fechar</button></div>
                        </div>
                    `;
                    document.getElementById('close-infobox-lenda').onclick = () => {
                        if (box.parentNode) box.parentNode.removeChild(box);
                    };
                    // Carrossel de imagens
                    if (lenda.images && lenda.images.length > 1) {
                        let idxImg = 0;
                        const imgEl = document.getElementById('carousel-img');
                        const indicator = document.getElementById('img-indicator');
                        document.getElementById('prev-img').onclick = () => {
                            idxImg = (idxImg - 1 + lenda.images.length) % lenda.images.length;
                            imgEl.src = lenda.images[idxImg];
                            indicator.textContent = `${idxImg + 1}/${lenda.images.length}`;
                        };
                        document.getElementById('next-img').onclick = () => {
                            idxImg = (idxImg + 1) % lenda.images.length;
                            imgEl.src = lenda.images[idxImg];
                            indicator.textContent = `${idxImg + 1}/${lenda.images.length}`;
                        };
                    }
                    // Animação de entrada
                    setTimeout(() => {
                        box.style.transform = 'translate(-50%, -50%) scale(1)';
                        box.style.opacity = '1';
                    }, 10);
                }

                // Adiciona OSM Buildings tileset (sempre antes do KML)
                // Alguns ambientes não possuem token Cesium Ion válido — protegemos essa chamada
                let buildingsTileset = null;
                try {
                    buildingsTileset = await Cesium.createOsmBuildingsAsync();
                    // Offset vertical em metros (ajuste conforme necessário)
                    const osmOffset = 0;
                    const osmTranslation = Cesium.Cartesian3.fromElements(0, 0, osmOffset, new Cesium.Cartesian3());
                    buildingsTileset.modelMatrix = Cesium.Matrix4.fromTranslation(osmTranslation);
                    viewer.scene.primitives.add(buildingsTileset);
                    // Garantir estado inicial: mostrar OSM (esta variante inicia com OSM visível)
                    buildingsTileset.show = true;
                } catch (e) {
                    // Falha ao carregar tileset pode ser devido a token Cesium Ion inválido (401)
                    console.warn('[WARN] Falha ao carregar OSM buildings tileset (Cesium Ion). Continuando sem tileset.', e);
                    buildingsTileset = null;
                }

                // Botão para mostrar/ocultar OSM temporariamente
                // Inicialmente mantemos as OSM visíveis (não mostrar sobre nossos GLBs)
                let osmVisible = true;
                const activeGlbs = new Set(); // ids de prédios que atualmente exibem GLB (detalhe)

                // Adiciona GLBs lowpoly ao iniciar (inclusive monumentos), mantendo como padrão as OSM originais visíveis
                // glbEntities[id] pode ser: Entity (low), Entity (detalhe único) ou Array<Entity> (detalhe multi-blocos)
                let glbEntities = {};

                // --- Preview Laranja (aplicado por padrão a todos os LOWs) ---
                const PREVIEW_ORANGE = Cesium.Color.fromCssColorString('#b45f00');

                function setEntityTintSingle(ent, apply) {
                    try {
                        if (!ent || !ent.model) return;
                        if (apply) {
                            ent.model.color = PREVIEW_ORANGE;
                            ent.model.colorBlendMode = Cesium.ColorBlendMode.REPLACE;
                            ent.model.colorBlendAmount = 1.0;
                        } else {
                            // Reverter: limpa propriedades (volta ao comportamento padrão)
                            try { ent.model.color = undefined; } catch (e) { }
                            try { ent.model.colorBlendMode = undefined; } catch (e) { }
                            try { ent.model.colorBlendAmount = undefined; } catch (e) { }
                        }
                    } catch (e) {
                        console.warn('Falha ao aplicar tint no entity', ent && ent.id, e);
                    }
                }
                // Nota: não temos botão; os LOWs recebem tint por padrão quando criados.
                // Helper para atualizar o estilo do tileset conforme osmVisible e quais GLBs estão ativos
                function updateTilesetShowForOSM(osmOn) {
                    if (!buildingsTileset) return;
                    if (!osmOn) {
                        // ocultar todo tileset
                        buildingsTileset.show = false;
                        return;
                    }

                    // Mostrar tileset, exceto os elementos que possuem um modelo 'low' (uri_base)
                    buildingsTileset.show = true;

                    // Reunir lista de IDs cuja OSM deve ser ocultada:
                    // - todos os ids que têm uri_base (temos um modelo low para eles)
                    // - além dos activeGlbs (detalhes abertos)
                    const hideSet = new Set();
                    Object.keys(buildingsMap).forEach(id => {
                        const d = buildingsMap[id];
                        if (d && d.uri_base) hideSet.add(String(id));
                    });
                    activeGlbs.forEach(id => hideSet.add(String(id)));

                    if (hideSet.size === 0) {
                        // sem ids a esconder: mostra tudo (estilo padrão)
                        buildingsTileset.style = new Cesium.Cesium3DTileStyle({
                            show: true,
                            color: "color('white', 1)"
                        });
                        return;
                    }

                    // Construir as condições para Cesium: cada condição é uma expressão string
                    // que compara ${elementId} com o id do prédio e retorna false para esconder.
                    const conditions = [];
                    hideSet.forEach(hid => {
                        // Se o id for numérico (apenas dígitos), compare sem aspas para evitar
                        // comparar número com string — caso contrário, compare como string.
                        let expr;
                        if (/^\d+$/.test(hid)) {
                            // Ex.: "${elementId} === 123456"
                            expr = "${elementId} === " + hid;
                        } else {
                            // Ex.: "${elementId} === 'abc-123'"
                            expr = "${elementId} === '" + hid + "'";
                        }
                        conditions.push([expr, false]);
                    });
                    // regra final: se nenhuma condição anterior for verdadeira, mostrar
                    conditions.push([true, true]);

                    buildingsTileset.style = new Cesium.Cesium3DTileStyle({
                        show: { conditions: conditions }
                    });
                }
                function addLowModel(id) {
                    const data = buildingsMap[id];
                    if (!data || !data.uri_base) {
                        console.debug('[DEBUG] addLowModel: skipped', id, '- sem uri_base');
                        return;
                    }
                    // Remove versões anteriores (low ou detail)
                    removeDetailModel(id);
                    const entLowExisting = viewer.entities.getById(id + '_low');
                    if (entLowExisting) viewer.entities.remove(entLowExisting);
                    const ent = viewer.entities.add({
                        id: id + '_low',
                        position: data.position,
                        orientation: Cesium.Transforms.headingPitchRollQuaternion(
                            data.position,
                            data.orientation
                        ),
                        model: {
                            uri: data.uri_base,
                            maximumScale: 20000,
                            heightReference: Cesium.HeightReference.NONE,
                            shadows: Cesium.ShadowMode.ENABLED
                        }
                    });
                    glbEntities[id] = ent; // referencia ao low
                    console.debug('[DEBUG] addLowModel: adicionado', id, data.uri_base);
                    // Aplicar tint laranja por padrão a todos os LOWs
                    try { setEntityTintSingle(ent, true); } catch (e) { console.warn('[WARN] Falha ao aplicar tint em', id, e); }
                    // Ao garantir o low, removemos id de activeGlbs (se estava)
                    if (activeGlbs.has(id)) {
                        activeGlbs.delete(id);
                        updateTilesetShowForOSM(osmVisible);
                    }
                }
                function addDetailModel(id) {
                    const data = buildingsMap[id];
                    if (!data || !data.uri_detail) return;
                    // Remove low anterior
                    const low = viewer.entities.getById(id + '_low');
                    if (low) viewer.entities.remove(low);
                    // uri_detail pode ser string ou array
                    if (Array.isArray(data.uri_detail)) {
                        const parts = [];
                        data.uri_detail.forEach((uri, idx) => {
                            const ent = viewer.entities.add({
                                id: id + '_detail_' + idx,
                                position: data.position,
                                orientation: Cesium.Transforms.headingPitchRollQuaternion(
                                    data.position,
                                    data.orientation
                                ),
                                model: {
                                    uri: uri,
                                    maximumScale: 20000,
                                    heightReference: Cesium.HeightReference.NONE,
                                    shadows: Cesium.ShadowMode.ENABLED
                                }
                            });
                                parts.push(ent);
                                console.debug('addDetailModel (part)', id, uri);
                        });
                        glbEntities[id] = parts; // array de partes
                        // marca como GLB ativo
                        activeGlbs.add(id);
                        updateTilesetShowForOSM(osmVisible);
                    } else {
                        const ent = viewer.entities.add({
                            id: id, // detalhe único usa id puro
                            position: data.position,
                            orientation: Cesium.Transforms.headingPitchRollQuaternion(
                                data.position,
                                data.orientation
                            ),
                            model: {
                                uri: data.uri_detail,
                                maximumScale: 20000,
                                heightReference: Cesium.HeightReference.NONE,
                                shadows: Cesium.ShadowMode.ENABLED
                            }
                        });
                        glbEntities[id] = ent;
                        console.debug('addDetailModel', id, data.uri_detail);
                        // marca como GLB ativo
                        activeGlbs.add(id);
                        updateTilesetShowForOSM(osmVisible);
                    }
                }
                function removeDetailModel(id) {
                    const current = glbEntities[id];
                    if (!current) return;
                    if (Array.isArray(current)) {
                        current.forEach(ent => viewer.entities.remove(ent));
                    } else if (current && current.id && (current.id.endsWith('_low') || current.id === id)) {
                        // handled elsewhere
                    } else {
                        viewer.entities.remove(current);
                    }
                    // Mantém chave para recriar low depois
                }
                // Inicial: adiciona somente lows (exceto plano 999999999)
                console.debug('[DEBUG] Iniciando carregamento de GLBs LOW...');
                Object.keys(buildingsMap).forEach(id => {
                    if (id === '999999999') return;
                    addLowModel(id);
                });
                console.debug('[DEBUG] Carregamento de GLBs LOW concluído. Total de entities:', viewer.entities.values.length);

                // Após criar os lows, aplica a lógica de mostrar/ocultar OSM conforme osmVisible
                updateTilesetShowForOSM(osmVisible);

                // Configura handler do botão toggle-osm agora que a função updateTilesetShowForOSM existe
                const toggleOsmBtn = document.getElementById('toggle-osm-btn');
                    if (toggleOsmBtn) {
                    toggleOsmBtn.onclick = function() {
                        osmVisible = !osmVisible;
                        updateTilesetShowForOSM(osmVisible);
                        // mantém rótulo simples e acessível; atualiza estado aria-pressed
                        try { toggleOsmBtn.setAttribute('aria-pressed', String(!!osmVisible)); } catch (e) { }
                    };
                    // rótulo fixo mais amigável para público leigo
                    toggleOsmBtn.innerText = 'Polígonos';
                    try { toggleOsmBtn.setAttribute('aria-pressed', String(!!osmVisible)); } catch (e) { }
                }

                // Evento de clique para mostrar ID e coordenadas do prédio OSM
                // Handler único para clique
                viewer.screenSpaceEventHandler.setInputAction(function (click) {
                    console.log('Clique detectado', click.position);
                    const pickedObject = viewer.scene.pick(click.position);
                    // Obtém coordenadas do clique
                    const cartesian = viewer.scene.pickPosition(click.position);
                    let coords = null;
                    if (cartesian) {
                        const cartographic = Cesium.Cartographic.fromCartesian(cartesian);
                        const lon = Cesium.Math.toDegrees(cartographic.longitude).toFixed(6);
                        const lat = Cesium.Math.toDegrees(cartographic.latitude).toFixed(6);
                        const height = cartographic.height.toFixed(2);
                        coords = { lon, lat, height };
                    }
                    if (Cesium.defined(pickedObject)) {
                        // Clique em marcador de lenda
                        if (pickedObject.id && pickedObject.id.lendaId !== undefined) {
                            showLendaInfobox(pickedObject.id.lendaId);
                            return;
                        }
                        // Clique no marcador de prefeitos
                        if (pickedObject.id && pickedObject.id.id === 'prefeitura_prefeitos_marker') {
                            showPrefeitosCarousel();
                            return;
                        }
                        // marcador de marechais agora é um botão DOM; clique no mapa não aciona
                        // Clique em OSM
                        if (pickedObject.getProperty) {
                            const elementId = pickedObject.getProperty('elementId');
                            if (elementId) {
                                console.log('[OSM] ID do prédio:', elementId, 'Coordenadas:', coords);
                                if (buildingsMap[elementId]) {
                                    toggleOsmAndGlb(elementId);
                                } else {
                                    // Mostra infobox simples para OSM sem GLB
                                    let oldBox = document.getElementById('infobox');
                                    if (oldBox) oldBox.parentNode.removeChild(oldBox);
                                    let box = document.createElement('div');
                                    box.id = 'infobox';
                                    box.style.position = 'fixed';
                                    box.style.top = '70px';
                                    box.style.right = '20px';
                                    box.style.setProperty('background', BOX_BG, 'important');
                                    box.style.setProperty('color', BOX_FG, 'important');
                                    box.style.border = '1.5px solid #aaa';
                                    box.style.padding = '14px';
                                    box.style.zIndex = 30;
                                    box.style.width = '320px';
                                    box.style.maxWidth = '95vw';
                                    box.style.maxHeight = '70vh';
                                    box.style.overflowY = 'auto';
                                    box.style.boxShadow = '0 2px 16px #000a';
                                    box.style.borderRadius = '10px';
                                    box.style.fontFamily = 'sans-serif';
                                    box.style.transform = 'translateX(380px)';
                                    box.style.opacity = '0';
                                    box.style.transition = 'transform 0.6s cubic-bezier(.6,1.5,.4,1), opacity 0.4s';
                                    document.body.appendChild(box);
                                    box.innerHTML = `
                                        <div style='text-align:center;color:#fff;'>
                                            <div style='font-size:20px;font-weight:bold;margin-bottom:8px;color:#fff;'>Prédio OSM</div>
                                            <small style='color:#ccc;'>ID: ${elementId}</small><br><br>
                                            <div style='margin-top:12px;text-align:left;font-size:15px;'>
                                                Coordenadas:<br>
                                                <span style='color:#fff;'>${coords ? `${coords.lat}, ${coords.lon} (alt: ${coords.height}m)` : 'Indisponível'}</span>
                                            </div>
                                            <div style='margin-top:12px;'><button id='close-infobox' style='background:#333;color:#fff;border:1px solid #888;border-radius:4px;padding:4px 18px;cursor:pointer;'>Fechar</button></div>
                                        </div>
                                    `;
                                    document.getElementById('close-infobox').onclick = () => {
                                        if (box.parentNode) box.parentNode.removeChild(box);
                                    };
                                    setTimeout(() => {
                                        box.style.transform = 'translateX(0)';
                                        box.style.opacity = '1';
                                        box.style.display = 'block';
                                    }, 10);
                                }
                            } else {
                                console.log('[OSM] Nenhum elementId encontrado. Coordenadas:', coords);
                            }
                            return;
                        }
                        // Clique em marcador turístico
                        if (pickedObject && pickedObject.id && pickedObject.id.tourismId) {
                            const tid = pickedObject.id.tourismId;
                            const p = tourismPoints.find(x => x.id === tid);
                            if (p) {
                                // Verificar missão (encontra índice do ponto turístico)
                                const idx = tourismPoints.indexOf(p);
                                console.debug('[TURISMO] Clicou em:', p.name, 'índice:', idx);
                                verificarMissaoClique('turismo', null, idx);
                                
                                // mostra um infobox simples
                                let old = document.getElementById('tourism-infobox');
                                if (old) old.parentNode.removeChild(old);
                                const box = document.createElement('div');
                                box.id = 'tourism-infobox';
                                box.style.position = 'fixed';
                                box.style.top = '50%';
                                box.style.left = '50%';
                                box.style.transform = 'translate(-50%, -50%)';
                                box.style.setProperty('background', BOX_BG, 'important');
                                box.style.setProperty('color', BOX_FG, 'important');
                                box.style.color = BOX_FG;
                                box.style.padding = '10px';
                                box.style.zIndex = 70;
                                box.style.maxWidth = '90vw';
                                box.style.maxHeight = '85vh';
                                box.style.border = '1px solid #666';
                                box.style.borderRadius = '8px';
                                box.style.boxShadow = '0 8px 32px rgba(0,0,0,0.6)';
                                box.innerHTML = `
                                        <div style='text-align:center;'>
                                            <img src='${(p.images && p.images[0]) ? p.images[0] : "placeholder_tour.jpg"}' style='width:300px;height:200px;object-fit:cover;border-radius:6px;display:block;margin:0 auto 8px;' />
                                        </div>
                                        <div style='font-weight:bold;margin-bottom:6px;'>${p.name}</div>
                                        <div style='display:flex;gap:6px;flex-wrap:wrap;align-items:center;'>
                                            <button id='tourism-open-page' style='padding:6px;background:'+BTN_BG+';color:'+BOX_FG+';'>Abrir página</button>
                                            ${p.infoUrl ? `<a id='tourism-more-info' href='${p.infoUrl}' target='_blank' style='color:#9fd;text-decoration:underline;font-size:13px;margin-left:4px;'>Mais informações</a>` : ''}
                                            <button id='tourism-close' style='padding:6px;background:'+BOX_BG+';color:'+BOX_FG+';'>Fechar</button>
                                        </div>`;
                                document.body.appendChild(box);
                                document.getElementById('tourism-close').onclick = () => { if (box.parentNode) box.parentNode.removeChild(box); };
                                document.getElementById('tourism-open-page').onclick = () => { if (p.pageUrl) window.open(p.pageUrl, '_blank'); };
                            }
                            return;
                        }
                        // Clique em GLB lowpoly de qualquer prédio
                        if (pickedObject.id && pickedObject.id.id && pickedObject.id.id.endsWith('_low')) {
                            const idBase = pickedObject.id.id.replace('_low', '');
                            const data = buildingsMap[idBase];
                            if (data && data.uri_detail) {
                                addDetailModel(idBase);
                                showInfobox(idBase);
                            }
                            return;
                        }
                        // Clique em GLB detalhado (único ou parte). Detecta baseId.
                        if (pickedObject.id && pickedObject.id.id) {
                            let pickedId = pickedObject.id.id;
                            let baseId = pickedId;
                            if (/(_detail_\d+)$/.test(pickedId)) {
                                baseId = pickedId.replace(/_detail_\d+$/, '');
                            }
                            if (buildingsMap[baseId] && glbEntities[baseId]) {
                                showInfobox(baseId);
                                return;
                            }
                        }
                    }
                }, Cesium.ScreenSpaceEventType.LEFT_CLICK);
                // Lógica de alternância OSM/GLB
                // ...existing code...

                // Modal fullscreen com model-viewer e abas [3D] [Info]
                function showModelViewerModal(id, glbUri, title, description) {
                    // Minimiza menu lateral automaticamente
                    const leftPanel = document.getElementById('left-panel');
                    if (leftPanel && !leftPanel.classList.contains('minimized')) {
                        leftPanel.classList.add('minimized');
                    }

                    // Remove modal antigo se existir
                    let oldModal = document.getElementById('mv-modal');
                    if (oldModal) oldModal.parentNode.removeChild(oldModal);

                    // Cria modal
                    const modal = document.createElement('div');
                    modal.id = 'mv-modal';
                    modal.style.cssText = `
                        position: fixed;
                        top: 50%;
                        left: 50%;
                        transform: translate(-50%, -50%);
                        width: 800px;
                        max-width: 95vw;
                        height: 600px;
                        max-height: 85vh;
                        background: ${BOX_BG};
                        border: 2px solid #aaa;
                        border-radius: 12px;
                        box-shadow: 0 8px 32px rgba(0,0,0,0.6);
                        z-index: 1000;
                        display: flex;
                        flex-direction: column;
                        overflow: hidden;
                        font-family: sans-serif;
                    `;

                    // Header com título e botão fechar
                    const header = document.createElement('div');
                    header.style.cssText = `
                        background: ${BOX_ALT};
                        color: ${BOX_FG};
                        padding: 12px 16px;
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        border-bottom: 1px solid #666;
                    `;
                    header.innerHTML = `
                        <div style="font-size: 18px; font-weight: bold;">${title}</div>
                        <button id="mv-close" style="background: #d33; color: #fff; border: none; border-radius: 4px; padding: 6px 12px; cursor: pointer; font-size: 16px;">✕</button>
                    `;

                    // Conteúdo principal (área alternável entre 3D e Info)
                    const content = document.createElement('div');
                    content.id = 'mv-content';
                    content.style.cssText = `
                        flex: 1;
                        overflow: auto;
                        position: relative;
                        background: transparent;
                    `;

                    // Área 3D (model-viewer)
                    const area3D = document.createElement('div');
                    area3D.id = 'mv-area-3d';
                    area3D.style.cssText = `
                        width: 100%;
                        height: 100%;
                        display: flex;
                        align-items: center;
                        justify-content: center;
                    `;
                    area3D.innerHTML = `<model-viewer id="mv-glb-${id}" src="${glbUri}" alt="${title}" auto-rotate camera-controls style="width: 100%; height: 100%; background: transparent;"></model-viewer>`;

                    // Área Info (descrição com zebra)
                    const areaInfo = document.createElement('div');
                    areaInfo.id = 'mv-area-info';
                    areaInfo.style.cssText = `
                        width: 100%;
                        height: 100%;
                        overflow-y: auto;
                        padding: 16px;
                        display: none;
                        color: ${BOX_FG};
                    `;
                    let zebraDesc = '';
                    if (description) {
                        let descParts = description.split(/<br\s*\/?><br\s*\/?>/);
                        zebraDesc = descParts.map((part, i) => `<div style='background:${i % 2 === 0 ? BOX_BG : BOX_ALT};padding:8px;border-radius:4px;margin-bottom:6px;'>${part}</div>`).join('');
                    }
                    areaInfo.innerHTML = zebraDesc || '<p style="color: #aaa;">Sem descrição disponível.</p>';

                    content.appendChild(area3D);
                    content.appendChild(areaInfo);

                    // Footer com abas [3D] [Info]
                    const footer = document.createElement('div');
                    footer.style.cssText = `
                        background: ${BOX_ALT};
                        padding: 10px 16px;
                        display: flex;
                        gap: 12px;
                        justify-content: center;
                        border-top: 1px solid #666;
                    `;
                    footer.innerHTML = `
                        <button id="tab-3d" style="background: ${BTN_BG}; color: ${BOX_FG}; border: 2px solid #4a9eff; border-radius: 6px; padding: 8px 24px; cursor: pointer; font-weight: bold; font-size: 15px;">🎨 3D</button>
                        <button id="tab-info" style="background: ${BTN_BG}; color: ${BOX_FG}; border: 1px solid #666; border-radius: 6px; padding: 8px 24px; cursor: pointer; font-size: 15px;">📄 Info</button>
                        <button id="back-to-low-modal" style="background: #d66; color: #fff; border: 1px solid #888; border-radius: 6px; padding: 8px 20px; cursor: pointer; font-size: 15px;">🔄 Simplificado</button>
                    `;

                    modal.appendChild(header);
                    modal.appendChild(content);
                    modal.appendChild(footer);
                    document.body.appendChild(modal);

                    // Função para restaurar controles da câmera (fix iOS bug)
                    function restoreCameraControls() {
                        try {
                            const controller = viewer.scene.screenSpaceCameraController;
                            controller.enableRotate = true;
                            controller.enableZoom = true;
                            controller.enableLook = true;
                            controller.enableTilt = true;
                            controller.enableTranslate = true;
                            controller.rotateEventTypes = [Cesium.CameraEventType.LEFT_DRAG];
                            controller.zoomEventTypes = [Cesium.CameraEventType.MIDDLE_DRAG, Cesium.CameraEventType.WHEEL, Cesium.CameraEventType.PINCH];
                            controller.panEventTypes = [Cesium.CameraEventType.RIGHT_DRAG];
                        } catch (e) {
                            console.warn('Erro ao restaurar controles da câmera:', e);
                        }
                    }

                    // Função para limpar recursos do model-viewer (fix iOS WebGL)
                    function cleanupModelViewer() {
                        try {
                            // 1. Encontrar e limpar o elemento model-viewer
                            const modelViewerElement = modal.querySelector('model-viewer');
                            if (modelViewerElement) {
                                console.debug('[CLEANUP] Limpando model-viewer resources...');
                                
                                // 2. Parar animação primeiro
                                if (modelViewerElement.pause) {
                                    modelViewerElement.pause();
                                }
                                
                                // 3. Remover auto-rotate (libera listeners)
                                modelViewerElement.removeAttribute('auto-rotate');
                                modelViewerElement.removeAttribute('camera-controls');
                                
                                // 4. Descarregar modelo (libera memória GPU)
                                modelViewerElement.src = '';
                                
                                // 5. Desconectar todos os observers internos
                                if (modelViewerElement.disconnectedCallback) {
                                    try {
                                        modelViewerElement.disconnectedCallback();
                                    } catch(e) { console.debug('[CLEANUP] disconnectedCallback error:', e); }
                                }
                                
                                // 6. Remover do DOM
                                if (modelViewerElement.parentNode) {
                                    modelViewerElement.parentNode.removeChild(modelViewerElement);
                                }
                            }
                            
                            // 7. Remover modal completo do DOM
                            if (modal.parentNode) {
                                modal.parentNode.removeChild(modal);
                            }
                            
                            // 8. Forçar garbage collection e resetar Cesium (iOS Safari fix)
                            setTimeout(() => {
                                // GC nativo (se disponível)
                                if (window.gc) window.gc();
                                
                                // Forçar Cesium a re-renderizar (limpa estado)
                                try {
                                    viewer.scene.requestRender();
                                } catch(e) {}
                            }, 100);
                            
                            // 9. Garantir controles da câmera após delay (iOS precisa mais tempo)
                            setTimeout(() => {
                                restoreCameraControls();
                                console.debug('[CLEANUP] Model-viewer cleanup completo (iOS optimized)');
                            }, 250);
                            
                        } catch (e) {
                            console.warn('[CLEANUP] Erro ao limpar model-viewer:', e);
                            // Fallback: apenas remove modal
                            if (modal.parentNode) modal.parentNode.removeChild(modal);
                            restoreCameraControls();
                        }
                    }

                    // Event listeners
                    document.getElementById('mv-close').onclick = () => {
                        cleanupModelViewer();
                        restoreCameraControls();
                    };

                    const tab3D = document.getElementById('tab-3d');
                    const tabInfo = document.getElementById('tab-info');

                    tab3D.onclick = () => {
                        area3D.style.display = 'flex';
                        areaInfo.style.display = 'none';
                        tab3D.style.border = '2px solid #4a9eff';
                        tab3D.style.fontWeight = 'bold';
                        tabInfo.style.border = '1px solid #666';
                        tabInfo.style.fontWeight = 'normal';
                    };

                    tabInfo.onclick = () => {
                        area3D.style.display = 'none';
                        areaInfo.style.display = 'block';
                        tabInfo.style.border = '2px solid #4a9eff';
                        tabInfo.style.fontWeight = 'bold';
                        tab3D.style.border = '1px solid #666';
                        tab3D.style.fontWeight = 'normal';
                    };

                    // Botão Simplificado: remove detalhe e volta ao LOW
                    document.getElementById('back-to-low-modal').onclick = () => {
                        const current = glbEntities[id];
                        if (current) {
                            if (Array.isArray(current)) {
                                current.forEach(ent => viewer.entities.remove(ent));
                            } else {
                                viewer.entities.remove(current);
                            }
                        }
                        if (activeGlbs.has(id)) {
                            activeGlbs.delete(id);
                            updateTilesetShowForOSM(osmVisible);
                        }
                        addLowModel(id);
                        cleanupModelViewer();
                        restoreCameraControls();
                    };

                    // Carrega model-viewer library (lazy-load)
                    function ensureModelViewer(cb) {
                        try {
                            if (window.customElements && customElements.get && customElements.get('model-viewer')) {
                                cb();
                                return;
                            }
                        } catch (e) { /* ignore */ }
                        const s = document.createElement('script');
                        s.type = 'module';
                        s.src = 'https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js';
                        s.onload = cb;
                        s.onerror = cb;
                        document.head.appendChild(s);
                    }
                    ensureModelViewer(() => {
                        console.debug('model-viewer modal ready:', glbUri);
                    });
                }

                // Cria/mostra infobox
                function showInfobox(id) {
                    const data = buildingsMap[id];
                    if (!data || !data.info) return;
                    let oldBox = document.getElementById('infobox');
                    if (oldBox) oldBox.parentNode.removeChild(oldBox);
                    let box = document.createElement('div');
                    box.id = 'infobox';
                    box.style.position = 'fixed';
                    box.style.top = '50%';
                    box.style.left = '50%';
                    box.style.transform = 'translate(-50%, -50%) scale(0.9)';
                    box.style.setProperty('background', BOX_BG, 'important');
                    box.style.setProperty('color', BOX_FG, 'important');
                    box.style.border = '1.5px solid #aaa';
                    box.style.padding = '14px';
                    box.style.zIndex = 30;
                    box.style.width = '320px';
                    box.style.maxWidth = '90vw';
                    box.style.maxHeight = '85vh';
                    box.style.overflowY = 'auto';
                    box.style.boxShadow = '0 8px 32px rgba(0,0,0,0.6)';
                    box.style.borderRadius = '10px';
                    box.style.fontFamily = 'sans-serif';
                    box.style.opacity = '0';
                    box.style.transition = 'transform 0.4s cubic-bezier(.6,1.5,.4,1), opacity 0.4s';
                    document.body.appendChild(box);

                    // Zebra para descrição longa
                    let zebraDesc = '';
                    if (data.info.description) {
                        let descParts = data.info.description.split(/<br\s*\/?><br\s*\/?/);
                        zebraDesc = descParts.map((part, i) => `<div style='background:${i % 2 === 0 ? BOX_BG : BOX_ALT};color:${BOX_FG};padding:4px 8px;border-radius:3px;margin-bottom:4px;'>${part}</div>`).join('');
                    }

                    let extraBtn = '';
                    if (data.uri_base && data.uri_detail) {
                        extraBtn = `<button id='back-to-low' style='background:'+BTN_BG+';color:'+BOX_FG+';border:1px solid #888;border-radius:4px;padding:2px 12px;cursor:pointer;'>Voltar ao modelo simplificado</button> `;
                    }

                    // Monta área de mídia: prefer GLB rotativo (model-viewer) se uri_detail for GLB ÚNICO,
                    // caso contrário usa carousel de imagens ou GIF/JPG padrão.
                    let mediaHtml = '';
                    const detailUris = (data.uri_detail && (Array.isArray(data.uri_detail) ? data.uri_detail : [data.uri_detail])) || [];
                    const firstDetail = detailUris.length > 0 ? detailUris[0] : null;
                    // Se há múltiplos GLBs (ex: Prefeitura com 4 blocos), NÃO usar model-viewer
                    // Apenas mostra foto JPG normal. GLBs são carregados no mapa via addDetailModel.
                    const isGlbDetail = detailUris.length === 1 && firstDetail && typeof firstDetail === 'string' && firstDetail.toLowerCase().endsWith('.glb');

                    if (isGlbDetail) {
                        // GLB único: abre modal fullscreen com abas [3D] [Info]
                        showModelViewerModal(id, firstDetail, data.info.title, data.info.description);
                        return; // Não cria infobox antiga
                    } else if (data.info.images && data.info.images.length > 0) {
                        if (data.info.images.length === 1) {
                            mediaHtml = `<div style="text-align:center;"><img id="carousel-img-glb" src="${data.info.images[0]}" class="img-building" style="max-width:100%;height:auto;border-radius:6px;" /></div>`;
                        } else {
                            mediaHtml = `
                                <div id="carousel-glb" style="text-align:center;">
                                    <img id="carousel-img-glb" src="${data.info.images[0]}" class="img-building" style="max-width:100%;height:auto;border-radius:6px;" />
                                    <br>
                                    <button id="prev-img-glb" style='background:'+BTN_BG+';color:'+BOX_FG+';border:1px solid #888;border-radius:4px;padding:2px 12px;cursor:pointer;'>◀</button>
                                    <span id="img-indicator-glb" style='color:${BOX_FG};'>1/${data.info.images.length}</span>
                                    <button id="next-img-glb" style='background:'+BTN_BG+';color:'+BOX_FG+';border:1px solid #888;border-radius:4px;padding:2px 12px;cursor:pointer;'>▶</button>
                                </div>`;
                        }
                    } else {
                        // fallback vazio/placeholder
                        mediaHtml = `<div style="text-align:center;"><img id="carousel-img-glb" src="placeholder_building.jpg" class="img-building" style="max-width:100%;height:auto;border-radius:6px;" /></div>`;
                    }
                    box.innerHTML = `
                        <div style='text-align:center;color:#fff;position:relative;min-height:120px;'>
                            <div style='font-size:20px;font-weight:bold;margin-bottom:8px;color:#fff;'>${data.info.title}</div>
                            <br>
                            ${mediaHtml}
                            <div style='margin-top:12px;text-align:left;font-size:15px;'>${zebraDesc}</div>
                            <div style='height:48px;'></div>
                            <div style='position:sticky;bottom:0;left:0;width:100%;background:'+BOX_ALT+';padding-top:8px;padding-bottom:8px;z-index:2;display:flex;gap:8px;justify-content:center;box-shadow:0 -2px 8px #000a;'>
                                ${extraBtn}<button id='close-infobox' style='background:'+BOX_BG+';color:'+BOX_FG+';border:1px solid #888;border-radius:4px;padding:4px 18px;cursor:pointer;'>Fechar</button>
                            </div>
                        </div>
                    `;
                    document.getElementById('close-infobox').onclick = () => {
                        if (box.parentNode) box.parentNode.removeChild(box);
                    };
                    // Carrossel de imagens GLB
                    // IMPORTANTE: quando estamos mostrando GLB rotativo (model-viewer)
                    // o HTML do carousel (ids como 'carousel-img-glb') não é inserido.
                    // Evita tentar acessar elementos nulos verificando se não estamos no
                    // fluxo do model-viewer e se os elementos existem.
                    if (!isGlbDetail && data.info.images && data.info.images.length > 1) {
                        let idxImg = 0;
                        const imgEl = document.getElementById('carousel-img-glb');
                        const indicator = document.getElementById('img-indicator-glb');
                        const prevBtn = document.getElementById('prev-img-glb');
                        const nextBtn = document.getElementById('next-img-glb');
                        if (imgEl && indicator && prevBtn && nextBtn) {
                            prevBtn.onclick = () => {
                                idxImg = (idxImg - 1 + data.info.images.length) % data.info.images.length;
                                imgEl.src = data.info.images[idxImg];
                                indicator.textContent = `${idxImg + 1}/${data.info.images.length}`;
                            };
                            nextBtn.onclick = () => {
                                idxImg = (idxImg + 1) % data.info.images.length;
                                imgEl.src = data.info.images[idxImg];
                                indicator.textContent = `${idxImg + 1}/${data.info.images.length}`;
                            };
                        }
                    }
                    if (data.uri_base && data.uri_detail) {
                        document.getElementById('back-to-low').onclick = () => {
                            // Remove detalhe(s) e re-adiciona low
                            const current = glbEntities[id];
                            if (Array.isArray(current)) {
                                current.forEach(ent => viewer.entities.remove(ent));
                            } else if (current) {
                                // pode ser entidade detalhada única
                                if (current.id && !current.id.endsWith('_low')) {
                                    viewer.entities.remove(current);
                                }
                            }
                            // marca que este id não tem mais GLB ativo
                            if (activeGlbs.has(id)) {
                                activeGlbs.delete(id);
                                updateTilesetShowForOSM(osmVisible);
                            }
                            addLowModel(id);
                            if (box.parentNode) box.parentNode.removeChild(box);
                        };
                    }
                    // Animação de entrada
                    setTimeout(() => {
                        box.style.transform = 'translate(-50%, -50%) scale(1)';
                        box.style.opacity = '1';
                    }, 10);
                }

                // --- Support functions: lazy-load Three.js and create combined viewer ---
                // Retorna Promise que resolve com os módulos {THREE, GLTFLoader, OrbitControls}
                function ensureThreeJS() {
                    // Cache global para não recarregar scripts
                    if (window.__three_mods) return Promise.resolve(window.__three_mods);

                    // Tenta primeiro carregar via CDN que reescreve imports (Skypack) — ESM
                    const trySkypack = () => {
                        console.debug('[DEBUG] ensureThreeJS: tentando carregar via Skypack (ESM)');
                        // skypack fornece módulos reescritos para navegadores
                        return import('https://cdn.skypack.dev/three@0.152.2').then(THREEmod => {
                            const THREE = THREEmod && (THREEmod.default || THREEmod.THREE || THREEmod);
                            return Promise.all([
                                Promise.resolve(THREE),
                                import('https://cdn.skypack.dev/three@0.152.2/examples/jsm/loaders/GLTFLoader').catch(e => { console.warn('GLTFLoader import failed via skypack', e); return null; }),
                                import('https://cdn.skypack.dev/three@0.152.2/examples/jsm/controls/OrbitControls').catch(e => { console.warn('OrbitControls import failed via skypack', e); return null; })
                            ]).then(([THREEok, GLTFmod, OrbitMod]) => {
                                // if essential pieces missing, reject to allow fallback
                                if (!THREEok || !GLTFmod || !OrbitMod) {
                                    return Promise.reject(new Error('Skypack did not provide required modules'));
                                }
                                const mods = { THREE: THREEok, GLTFLoader: (GLTFmod && (GLTFmod.GLTFLoader || GLTFmod.default)) || null, OrbitControls: (OrbitMod && (OrbitMod.OrbitControls || OrbitMod.default)) || null };
                                window.__three_mods = mods;
                                return mods;
                            });
                        });
                    };

                    // Fallback para UMD (scripts não-modulares) se Skypack falhar
                    const fallbackUmd = () => {
                        console.debug('[DEBUG] ensureThreeJS: fallback UMD loader');
                        return new Promise((resolve, reject) => {
                            if (window.THREE) {
                                window.__three_mods = { THREE: window.THREE, GLTFLoader: window.THREE.GLTFLoader, OrbitControls: window.THREE.OrbitControls };
                                resolve(window.__three_mods);
                                return;
                            }
                            function loadScript(src, onload, onerror) {
                                const s = document.createElement('script');
                                s.src = src;
                                s.onload = onload;
                                s.onerror = onerror;
                                document.head.appendChild(s);
                            }
                            const threeUrl = 'https://cdn.jsdelivr.net/npm/three@0.152.2/build/three.min.js';
                            const gltfUrl = 'https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/loaders/GLTFLoader.js';
                            const orbitUrl = 'https://cdn.jsdelivr.net/npm/three@0.152.2/examples/js/controls/OrbitControls.js';
                            loadScript(threeUrl, () => {
                                setTimeout(() => {
                                    if (!window.THREE) { reject(new Error('Three.js failed to attach to window.THREE')); return; }
                                    loadScript(gltfUrl, () => {
                                        loadScript(orbitUrl, () => {
                                            window.__three_mods = { THREE: window.THREE, GLTFLoader: window.THREE.GLTFLoader || window.GLTFLoader, OrbitControls: window.THREE.OrbitControls || window.OrbitControls };
                                            resolve(window.__three_mods);
                                        }, () => { console.warn('OrbitControls load error'); resolve(window.__three_mods); });
                                    }, () => { console.warn('GLTFLoader load error'); resolve(window.__three_mods); });
                                }, 10);
                            }, (e) => { reject(new Error('Failed to load Three.js: ' + e)); });
                        });
                    };

                    // Executa tentativa ESM; se falhar, usa fallback UMD
                    return trySkypack().catch(err => {
                        console.warn('[WARN] Skypack import failed, usando fallback UMD', err);
                        return fallbackUmd();
                    });
                }

                // Cria um viewer combinado que carrega várias GLBs e as adiciona a uma cena única
                function createCombinedViewer(mods, uris, hostElement, id) {
                    const THREE = mods.THREE;
                    const GLTFLoader = mods.GLTFLoader;
                    const OrbitControls = mods.OrbitControls;

                    // Elemento canvas/renderer
                    const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
                    renderer.setPixelRatio(window.devicePixelRatio || 1);
                    renderer.setSize(hostElement.clientWidth, hostElement.clientHeight, false);
                    renderer.domElement.style.width = '100%';
                    renderer.domElement.style.height = '100%';
                    hostElement.appendChild(renderer.domElement);

                    const scene = new THREE.Scene();
                    const camera = new THREE.PerspectiveCamera(45, hostElement.clientWidth / hostElement.clientHeight, 0.1, 10000);
                    camera.position.set(0, 2, 6);

                    const ambient = new THREE.AmbientLight(0xffffff, 0.9);
                    scene.add(ambient);
                    const dir = new THREE.DirectionalLight(0xffffff, 0.6);
                    dir.position.set(10, 10, 10);
                    scene.add(dir);

                    const group = new THREE.Group();
                    scene.add(group);

                    // Resolve GLTFLoader constructor from various possible sources (ESM module, UMD global)
                    let GLTFLoaderCtor = null;
                    if (mods && mods.GLTFLoader) GLTFLoaderCtor = mods.GLTFLoader;
                    if (!GLTFLoaderCtor && mods && mods.THREE && mods.THREE.GLTFLoader) GLTFLoaderCtor = mods.THREE.GLTFLoader;
                    if (!GLTFLoaderCtor && window && window.GLTFLoader) GLTFLoaderCtor = window.GLTFLoader;
                    if (!GLTFLoaderCtor && window && window.THREE && window.THREE.GLTFLoader) GLTFLoaderCtor = window.THREE.GLTFLoader;
                    if (!GLTFLoaderCtor) {
                        const err = new Error('GLTFLoader not available');
                        console.warn('createCombinedViewer:', err);
                        throw err;
                    }
                    const loader = new GLTFLoaderCtor();
                    const loadPromises = uris.map(uri => new Promise((resolve, reject) => {
                        loader.load(uri, gltf => resolve(gltf.scene), undefined, err => reject(err));
                    }));

                    let controls = new OrbitControls(camera, renderer.domElement);
                    controls.enableDamping = true;
                    controls.dampingFactor = 0.06;
                    controls.autoRotate = true;
                    controls.autoRotateSpeed = 1.0;

                    let rafId = null;

                    Promise.all(loadPromises).then(objects => {
                        objects.forEach(obj => {
                            group.add(obj);
                        });
                        // Ajusta escala/centralização automática
                        const bbox = new THREE.Box3().setFromObject(group);
                        const size = bbox.getSize(new THREE.Vector3());
                        const center = bbox.getCenter(new THREE.Vector3());
                        const maxDim = Math.max(size.x, size.y, size.z);
                        if (maxDim > 0) {
                            const fitDistance = maxDim * 1.8;
                            camera.position.set(center.x, center.y + maxDim * 0.3, center.z + fitDistance);
                            camera.lookAt(center);
                            controls.target.copy(center);
                        }
                        // Render loop
                        function animate() {
                            controls.update();
                            renderer.render(scene, camera);
                            rafId = requestAnimationFrame(animate);
                        }
                        animate();
                    }).catch(err => {
                        console.warn('Erro ao carregar GLBs combinados:', err);
                        hostElement.innerHTML = '<div style="color:#fdd;">Erro ao carregar arquivos 3D (ver console para detalhes).</div>';
                    });

                    // Recalcula tamanho se host mudar
                    function onResize() {
                        const w = hostElement.clientWidth;
                        const h = hostElement.clientHeight;
                        camera.aspect = w / h;
                        camera.updateProjectionMatrix();
                        renderer.setSize(w, h, false);
                    }
                    window.addEventListener('resize', onResize);

                    // Quando o infobox for fechado, garantimos cleanup removendo o renderer
                    const closeHandler = function() {
                        // procura se infobox ainda existe
                        const inf = document.getElementById('infobox');
                        if (!inf || !inf.parentNode) {
                            // infobox removido: faz cleanup
                            try { cancelAnimationFrame(rafId); } catch (e) { }
                            try { renderer.dispose && renderer.dispose(); } catch (e) { }
                            try { hostElement.parentNode && hostElement.parentNode.removeChild(hostElement); } catch (e) { }
                            window.removeEventListener('resize', onResize);
                            window.removeEventListener('click', closeHandler);
                        }
                    };
                    // adiciona listener genérico — será acionado quando usuário fechar a infobox (remove do DOM)
                    window.addEventListener('click', closeHandler);
                }

                function toggleOsmAndGlb(id) {
                    // Quando clicar em OSM de um prédio com GLB: abre detalhe e garante que
                    // o OSM deste prédio será ocultado enquanto o GLB estiver ativo.
                    // addDetailModel já adiciona id em activeGlbs e chama updateTilesetShowForOSM.
                    const prev = glbEntities[id];
                    if (Array.isArray(prev)) prev.forEach(ent => viewer.entities.remove(ent));
                    else if (prev) viewer.entities.remove(prev);
                    addDetailModel(id);
                }

                // Handler duplicado removido para evitar sobrescrita

                // ==================== SISTEMA DE MISSÕES ====================
                // Array de 30 missões culturais (mix de edifícios, monumentos, lendas, turismo, marechais)
                const missoesCulturais = [
                    // Edifícios icônicos (11 missões)
                    { id: 'prefeitura', tipo: 'edificio', nome: 'Prefeitura Municipal', targetId: '494741651' },
                    { id: 'matriz', tipo: 'edificio', nome: 'Igreja Matriz', targetId: '496683075' },
                    { id: 'provincia', tipo: 'edificio', nome: 'Banco da Província', targetId: '496696965' },
                    { id: 'banrisul', tipo: 'edificio', nome: 'Banrisul', targetId: '228625933' },
                    { id: 'sobrado', tipo: 'edificio', nome: 'Sobrado Dom Pedro II', targetId: '496697003' },
                    { id: 'galo', tipo: 'edificio', nome: 'Igreja do Galo', targetId: '502141804' },
                    { id: 'maconaria', tipo: 'edificio', nome: 'Maçonaria Rocha Negra', targetId: '496696981' },
                    { id: 'amarelo', tipo: 'edificio', nome: 'Casarão Amarelo', targetId: '496680298' },
                    { id: 'guarani', tipo: 'edificio', nome: 'Clube Guarani', targetId: '505353915' },
                    { id: 'comercial', tipo: 'edificio', nome: 'Clube Comercial', targetId: '496692933' },
                    { id: 'museu_feb', tipo: 'edificio', nome: 'Museu Gaúcho da FEB', targetId: '262049292' },
                    
                    // Monumentos (3 missões)
                    { id: 'monumento_feb', tipo: 'monumento', nome: 'Monumento Heróis da FEB', targetId: '111111111' },
                    { id: 'monumento_sampaio', tipo: 'monumento', nome: 'Monumento Sampaio Marques Luz', targetId: '222222222' },
                    { id: 'monumento_celestino', tipo: 'monumento', nome: 'Monumento Dr. Celestino', targetId: '333333333' },
                    
                    // Lendas (5 missões)
                    { id: 'lenda_fuzilados', tipo: 'lenda', nome: 'Os Fuzilados', lendaIdx: 0 },
                    { id: 'lenda_negrinho', tipo: 'lenda', nome: 'Negrinho da Sanga Funda', lendaIdx: 1 },
                    { id: 'lenda_guapa', tipo: 'lenda', nome: 'Túmulo da Guapa', lendaIdx: 2 },
                    { id: 'lenda_noivos', tipo: 'lenda', nome: 'Os Noivos', lendaIdx: 3 },
                    { id: 'lenda_cigana', tipo: 'lenda', nome: 'A Cigana', lendaIdx: 4 },
                    
                    // Turismo (8 missões)
                    { id: 'tour_galo', tipo: 'turismo', nome: 'Igreja do Galo', tourismIdx: 0 },
                    { id: 'tour_6be', tipo: 'turismo', nome: '6º Batalhão de Engenharia', tourismIdx: 1 },
                    { id: 'tour_sepe', tipo: 'turismo', nome: 'Sepé Tiaraju', tourismIdx: 2 },
                    { id: 'tour_arcanjo', tipo: 'turismo', nome: 'Arcanjo São Gabriel', tourismIdx: 3 },
                    { id: 'tour_prefeitura', tipo: 'turismo', nome: 'Palácio Plácido de Castro', tourismIdx: 4 },
                    { id: 'tour_matriz', tipo: 'turismo', nome: 'Igreja Matriz', tourismIdx: 5 },
                    { id: 'tour_feb', tipo: 'turismo', nome: 'Museu Gaúcho da FEB', tourismIdx: 6 },
                    { id: 'tour_biblioteca', tipo: 'turismo', nome: 'Secretaria de Turismo', tourismIdx: 7 }
                    
                    // MISSÕES COMENTADAS - Dependem de navegação manual por carrossel (índice não confiável)
                    // Futura implementação: detectar abertura do carrossel ao invés de índice específico
                    
                    // Marechais (5 missões - COMENTADAS: verificação por índice não funciona com navegação manual)
                    // { id: 'marechal_joao_propio', tipo: 'marechal', nome: 'Marechal João Propício', marechalIdx: 0 },
                    // { id: 'marechal_mallet', tipo: 'marechal', nome: 'Marechal Mallet', marechalIdx: 1 },
                    // { id: 'marechal_fabio', tipo: 'marechal', nome: 'Marechal Fábio Azambuja', marechalIdx: 2 },
                    // { id: 'marechal_hermes', tipo: 'marechal', nome: 'Marechal Hermes da Fonseca', marechalIdx: 3 },
                    // { id: 'marechal_mascarenhas', tipo: 'marechal', nome: 'Marechal Mascarenhas de Moraes', marechalIdx: 4 },
                    
                    // Prefeitos (3 missões - COMENTADAS: verificação por índice não funciona com navegação manual)
                    // { id: 'pref_sampaio', tipo: 'prefeito', nome: 'José Sampaio Marques Luz', prefeitoIdx: 12 },
                    // { id: 'pref_celestino', tipo: 'prefeito', nome: 'Dr. Celestino Cavalheiro', prefeitoIdx: 3 },
                    // { id: 'pref_baltazar', tipo: 'prefeito', nome: 'Baltazar Teixeira', prefeitoIdx: 19 },
                    
                    // Homens Ilustres (6 missões - COMENTADAS: verificação por índice não funciona com navegação manual)
                    // { id: 'ilu_abbott', tipo: 'ilustre', nome: 'Fernando Abbott', ilustreIdx: 0 },
                    // { id: 'ilu_alcides', tipo: 'ilustre', nome: 'Alcides Maia', ilustreIdx: 1 },
                    // { id: 'ilu_leonel', tipo: 'ilustre', nome: 'Pe. Leonel Franca', ilustreIdx: 2 },
                    // { id: 'ilu_assis', tipo: 'ilustre', nome: 'Joaquim Assis Brasil', ilustreIdx: 3 },
                    // { id: 'ilu_placido', tipo: 'ilustre', nome: 'José Plácido de Castro', ilustreIdx: 4 },
                    // { id: 'ilu_heron', tipo: 'ilustre', nome: 'Heron Domingues', ilustreIdx: 5 }
                ];

                console.debug('[MISSÕES] Total de missões carregadas:', missoesCulturais.length);

                // LocalStorage: carregar progresso
                function loadMissoesProgress() {
                    try {
                        const saved = localStorage.getItem('missoesProgress');
                        if (saved) {
                            const progress = JSON.parse(saved);
                            // Limpar IDs inválidos (missões que não existem mais no array)
                            const validIds = missoesCulturais.map(m => m.id);
                            const cleaned = {};
                            let removidos = 0;
                            for (const id in progress) {
                                if (validIds.includes(id)) {
                                    cleaned[id] = progress[id];
                                } else {
                                    removidos++;
                                }
                            }
                            if (removidos > 0) {
                                console.debug('[MISSÕES] Limpeza automática: removidos', removidos, 'IDs inválidos do progresso');
                                saveMissoesProgress(cleaned);
                            }
                            return cleaned;
                        }
                    } catch (e) {
                        console.warn('Erro ao carregar progresso de missões:', e);
                    }
                    return {};
                }

                // LocalStorage: salvar progresso
                function saveMissoesProgress(progress) {
                    try {
                        localStorage.setItem('missoesProgress', JSON.stringify(progress));
                    } catch (e) {
                        console.warn('Erro ao salvar progresso de missões:', e);
                    }
                }

                let missoesProgress = loadMissoesProgress();
                let missoesPopupOpen = false;
                let missaoAtiva = null; // Missão atual do jogador
                let missaoModoAtivo = false; // Se está no modo de missão ativa

                // Obter próxima missão não completa (sequencial)
                function getNextMissao() {
                    for (let missao of missoesCulturais) {
                        if (!missoesProgress[missao.id]) {
                            return missao;
                        }
                    }
                    return null; // Todas completas!
                }

                // Sortear missão aleatória não completa
                function getRandomMissao() {
                    const incompletas = missoesCulturais.filter(m => !missoesProgress[m.id]);
                    if (incompletas.length === 0) return null;
                    return incompletas[Math.floor(Math.random() * incompletas.length)];
                }

                // Contador de missões completas
                function getCompletedCount() {
                    return Object.values(missoesProgress).filter(v => v === true).length;
                }

                // Ativar missão (ao clicar no botão 🎯)
                function ativarMissao() {
                    missaoAtiva = getNextMissao();
                    if (!missaoAtiva) {
                        showVictoryScreen(); // Todas completas!
                        return;
                    }
                    missaoModoAtivo = true;
                    missoesPopupOpen = true;
                    renderMissaoAtivaPopup();
                }

                // Verificar se clique corresponde à missão ativa
                function verificarMissaoClique(tipo, targetId, idx) {
                    if (!missaoModoAtivo || !missaoAtiva) {
                        console.debug('[MISSÃO] Modo inativo ou sem missão ativa');
                        return;
                    }

                    let acertou = false;

                    // Verifica tipo + ID/índice
                    if (tipo === 'edificio' || tipo === 'monumento') {
                        // Aceita se for o targetId correto (independente do tipo declarado)
                        acertou = (missaoAtiva.targetId === targetId);
                    } else if (tipo === 'lenda') {
                        acertou = (missaoAtiva.tipo === 'lenda' && missaoAtiva.lendaIdx === idx);
                    } else if (tipo === 'turismo') {
                        acertou = (missaoAtiva.tipo === 'turismo' && missaoAtiva.tourismIdx === idx);
                        console.debug('[MISSÃO] Turismo check:', {
                            missaoTipo: missaoAtiva.tipo,
                            missaoIdx: missaoAtiva.tourismIdx,
                            cliqueIdx: idx,
                            match: acertou
                        });
                    } else if (tipo === 'marechal') {
                        acertou = (missaoAtiva.tipo === 'marechal' && missaoAtiva.marechalIdx === idx);
                    } else if (tipo === 'prefeito') {
                        acertou = (missaoAtiva.tipo === 'prefeito' && missaoAtiva.prefeitoIdx === idx);
                    } else if (tipo === 'ilustre') {
                        acertou = (missaoAtiva.tipo === 'ilustre' && missaoAtiva.ilustreIdx === idx);
                    }

                    console.debug('[MISSÃO] Verificação:', { 
                        tipo, 
                        targetId, 
                        idx, 
                        missaoAtiva: missaoAtiva.nome, 
                        missaoTipo: missaoAtiva.tipo,
                        acertou 
                    });

                    if (acertou) {
                        console.debug('[MISSÃO] ✅ ACERTOU!');
                        completeMissaoAtiva();
                    } else {
                        console.debug('[MISSÃO] ❌ ERROU!');
                        showErroFeedback();
                    }
                }

                // Completar missão ativa
                function completeMissaoAtiva() {
                    if (!missaoAtiva) return;
                    
                    missoesProgress[missaoAtiva.id] = true;
                    saveMissoesProgress(missoesProgress);
                    
                    // Mostra GIF de sucesso + próxima missão
                    showSucessoGif(() => {
                        const completed = getCompletedCount();
                        if (completed >= missoesCulturais.length) {
                            showVictoryScreen();
                        } else {
                            missaoAtiva = getNextMissao();
                            renderMissaoAtivaPopup();
                        }
                    });
                }

                // Mostrar GIF de sucesso
                function showSucessoGif(callback) {
                    const popup = document.getElementById('missoes-popup');
                    if (!popup) return;

                    const gifArea = document.getElementById('missao-gif-area');
                    if (gifArea) {
                        // GIF de celebração (confete)
                        gifArea.innerHTML = `<img src="https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExOHJ5cjN6dWp6eGZ5Yzh1YjBxM3VvZ3N6azRlemZ6Y3puemZ6Y3puZiZlcD12MV9naWZzX3NlYXJjaCZjdD1n/kyLYXonQYYfwYDIeZl/giphy.gif?${Date.now()}" style="width:100%;height:120px;object-fit:contain;border-radius:8px;background:#2ecc71;">`;
                        gifArea.style.display = 'block';

                        setTimeout(() => {
                            gifArea.style.display = 'none';
                            gifArea.innerHTML = '';
                            if (callback) callback();
                        }, 2000);
                    }
                }

                // Mostrar GIF de erro
                function showErroFeedback() {
                    const popup = document.getElementById('missoes-popup');
                    if (!popup) return;

                    const gifArea = document.getElementById('missao-gif-area');
                    if (gifArea) {
                        // GIF de X vermelho (erro)
                        gifArea.innerHTML = `<img src="https://media.giphy.com/media/v1.Y2lkPTc5MGI3NjExNnZ5cjN6dWp6eGZ5Yzh1YjBxM3VvZ3N6azRlemZ6Y3puemZ6Y3puZiZlcD12MV9naWZzX3NlYXJjaCZjdD1n/T7j5439wv9iq4/giphy.gif?${Date.now()}" style="width:100%;height:120px;object-fit:contain;border-radius:8px;background:#e74c3c;">`;
                        gifArea.style.display = 'block';

                        // Toast vermelho SEMPRE aparece
                        const toast = document.createElement('div');
                        toast.style.position = 'fixed';
                        toast.style.top = '20px';
                        toast.style.left = '50%';
                        toast.style.transform = 'translateX(-50%)';
                        toast.style.background = '#e74c3c';
                        toast.style.color = '#fff';
                        toast.style.padding = '12px 24px';
                        toast.style.borderRadius = '8px';
                        toast.style.boxShadow = '0 4px 12px rgba(0,0,0,0.3)';
                        toast.style.zIndex = '99999';
                        toast.style.fontSize = '15px';
                        toast.style.fontWeight = 'bold';
                        toast.style.opacity = '0';
                        toast.style.transition = 'opacity 0.3s';
                        toast.innerHTML = `❌ Local errado!<br><span style="font-size:13px;font-weight:normal;">Procure: ${missaoAtiva.nome}</span>`;
                        document.body.appendChild(toast);
                        
                        // Forçar aparição do toast
                        setTimeout(() => {
                            toast.style.opacity = '1';
                        }, 10);

                        setTimeout(() => {
                            if (toast.parentNode) toast.parentNode.removeChild(toast);
                        }, 2500);

                        setTimeout(() => {
                            gifArea.style.display = 'none';
                            gifArea.innerHTML = '';
                        }, 2000);
                    }
                }

                // Tela de vitória (todas as missões completas)
                function showVictoryScreen() {
                    missaoModoAtivo = false;
                    const popup = document.getElementById('missoes-popup');
                    if (!popup) return;

                    popup.innerHTML = `
                        <div style='text-align:center;padding:20px;'>
                            <img src="https://media.giphy.com/media/g9582DNuQppxC/giphy.gif" style="width:100%;height:150px;object-fit:contain;border-radius:8px;margin-bottom:16px;">
                            <div style='font-size:24px;font-weight:bold;color:#2ecc71;margin-bottom:12px;'>🎉 PARABÉNS! 🎉</div>
                            <div style='font-size:16px;color:#ddd;margin-bottom:20px;'>Você completou todas as 40 missões culturais de São Gabriel!</div>
                            <button id='victory-close' style='background:#3498db;color:#fff;border:none;border-radius:6px;padding:12px 24px;cursor:pointer;font-size:16px;font-weight:bold;'>🏆 Fechar</button>
                        </div>
                    `;

                    document.getElementById('victory-close').onclick = () => {
                        closeMissoesPopup();
                    };
                }

                // Renderizar popup de missão ativa
                function renderMissaoAtivaPopup() {
                    let popup = document.getElementById('missoes-popup');
                    if (!popup) {
                        popup = document.createElement('div');
                        popup.id = 'missoes-popup';
                        popup.style.position = 'fixed';
                        popup.style.bottom = '80px';
                        popup.style.right = '20px';
                        popup.style.width = '320px';
                        popup.style.maxWidth = '90vw';
                        popup.style.background = BOX_BG;
                        popup.style.color = BOX_FG;
                        popup.style.border = '1.5px solid #aaa';
                        popup.style.borderRadius = '10px';
                        popup.style.boxShadow = '0 8px 32px rgba(0,0,0,0.6)';
                        popup.style.zIndex = '150';
                        popup.style.padding = '14px';
                        popup.style.transform = 'translateY(500px)';
                        popup.style.opacity = '0';
                        popup.style.transition = 'transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity 0.4s';
                        document.body.appendChild(popup);
                    }

                    const completed = getCompletedCount();
                    
                    popup.innerHTML = `
                        <div id='missao-gif-area' style='display:none;margin-bottom:12px;'></div>
                        
                        <div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid #666;'>
                            <div style='font-size:18px;font-weight:bold;'>🎯 Missão Ativa</div>
                            <button id='missoes-popup-close' style='background:#d33;color:#fff;border:none;border-radius:4px;padding:5px 10px;cursor:pointer;font-size:16px;'>✕</button>
                        </div>
                        
                        <div style='background:${BOX_ALT};padding:16px;border-radius:8px;border:2px solid #3498db;margin-bottom:12px;'>
                            <div style='font-size:16px;font-weight:bold;color:#3498db;margin-bottom:8px;'>📍 ${missaoAtiva.nome}</div>
                            <div style='font-size:12px;color:#aaa;'>Tipo: ${missaoAtiva.tipo}</div>
                        </div>
                        
                        <div style='margin-bottom:12px;font-size:14px;color:#bbb;'>
                            Progresso: <b style='color:#2ecc71;'>${completed}/27</b> ✅
                        </div>
                        
                        <div style='display:flex;gap:8px;'>
                            <button id='missao-pular' style='flex:1;background:#f39c12;color:#fff;border:none;border-radius:6px;padding:10px;cursor:pointer;font-size:14px;font-weight:bold;'>⏩ Pular</button>
                            <button id='missao-ver-todas' style='flex:1;background:${BTN_BG};color:${BOX_FG};border:1px solid #666;border-radius:6px;padding:10px;cursor:pointer;font-size:14px;'>📋 Ver Todas</button>
                        </div>
                    `;

                    document.getElementById('missoes-popup-close').onclick = () => {
                        missaoModoAtivo = false;
                        closeMissoesPopup();
                    };

                    document.getElementById('missao-pular').onclick = () => {
                        missaoAtiva = getRandomMissao();
                        if (missaoAtiva) renderMissaoAtivaPopup();
                    };

                    document.getElementById('missao-ver-todas').onclick = () => {
                        renderMissoesListaCompleta();
                    };

                    // Animação de entrada
                    setTimeout(() => {
                        popup.style.transform = 'translateY(0)';
                        popup.style.opacity = '1';
                    }, 10);
                }

                // Renderizar lista completa de missões (modo consulta)
                function renderMissoesListaCompleta() {
                    let popup = document.getElementById('missoes-popup');
                    if (!popup) {
                        popup = document.createElement('div');
                        popup.id = 'missoes-popup';
                        popup.style.position = 'fixed';
                        popup.style.bottom = '80px';
                        popup.style.right = '20px';
                        popup.style.width = '320px';
                        popup.style.maxWidth = '90vw';
                        popup.style.background = BOX_BG;
                        popup.style.color = BOX_FG;
                        popup.style.border = '1.5px solid #aaa';
                        popup.style.borderRadius = '10px';
                        popup.style.boxShadow = '0 8px 32px rgba(0,0,0,0.6)';
                        popup.style.zIndex = '150';
                        popup.style.padding = '14px';
                        popup.style.transform = 'translateY(500px)';
                        popup.style.opacity = '0';
                        popup.style.transition = 'transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55), opacity 0.4s';
                        document.body.appendChild(popup);
                    }

                    const completed = getCompletedCount();
                    let html = `
                        <div style='display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;padding-bottom:8px;border-bottom:1px solid #666;'>
                            <div style='font-size:18px;font-weight:bold;'>📋 Todas as Missões</div>
                            <button id='missoes-popup-close' style='background:#d33;color:#fff;border:none;border-radius:4px;padding:5px 10px;cursor:pointer;font-size:16px;'>✕</button>
                        </div>
                        <div style='margin-bottom:12px;font-size:14px;color:#bbb;'>
                            Progresso: <b style='color:#2ecc71;'>${completed}/27</b> completas
                        </div>
                        <div style='max-height:50vh;overflow-y:auto;display:flex;flex-direction:column;gap:6px;'>
                    `;

                    missoesCulturais.forEach(missao => {
                        const isComplete = missoesProgress[missao.id] === true;
                        const bgColor = isComplete ? '#2c5f2d' : BOX_ALT;
                        const icon = isComplete ? '✅' : '⬜';
                        html += `
                            <div style='background:${bgColor};padding:8px 10px;border-radius:6px;display:flex;align-items:center;gap:10px;border:1px solid ${isComplete ? '#2ecc71' : '#555'};'>
                                <span style='font-size:18px;'>${icon}</span>
                                <div style='flex:1;'>
                                    <div style='font-size:13px;font-weight:${isComplete ? 'normal' : 'bold'};color:${isComplete ? '#aaa' : BOX_FG};${isComplete ? 'text-decoration:line-through;' : ''}'>${missao.nome}</div>
                                    <div style='font-size:10px;color:#888;'>${missao.tipo}</div>
                                </div>
                            </div>
                        `;
                    });

                    html += `
                        </div>
                        <div style='margin-top:12px;padding-top:12px;border-top:1px solid #666;'>
                            <button id='missoes-resetar' style='width:100%;background:#e74c3c;color:#fff;border:none;border-radius:6px;padding:10px;cursor:pointer;font-size:14px;font-weight:bold;'>🔄 Resetar Progresso</button>
                        </div>
                    `;
                    popup.innerHTML = html;

                    // Anima entrada
                    setTimeout(() => {
                        popup.style.transform = 'translateY(0)';
                        popup.style.opacity = '1';
                    }, 50);

                    document.getElementById('missoes-popup-close').onclick = () => {
                        closeMissoesPopup();
                    };

                    document.getElementById('missoes-resetar').onclick = () => {
                        if (confirm('Tem certeza que deseja resetar todo o progresso das missões? Esta ação não pode ser desfeita!')) {
                            missoesProgress = {};
                            saveMissoesProgress(missoesProgress);
                            missaoAtiva = null;
                            missaoModoAtivo = false;
                            // Atualiza botão flutuante
                            const btn = document.getElementById('missoes-float-btn');
                            if (btn) {
                                btn.innerHTML = `🎯<br><span style="font-size:11px;">0/27</span>`;
                            }
                            renderMissoesListaCompleta();
                            alert('✅ Progresso resetado com sucesso!');
                        }
                    };
                }

                function closeMissoesPopup() {
                    const popup = document.getElementById('missoes-popup');
                    if (popup) {
                        popup.style.transform = 'translateY(500px)';
                        popup.style.opacity = '0';
                        setTimeout(() => {
                            if (popup.parentNode) popup.parentNode.removeChild(popup);
                        }, 400);
                    }
                    missoesPopupOpen = false;
                }

                // Botão flutuante bottom-right
                const missoesFloatBtn = document.createElement('button');
                missoesFloatBtn.id = 'missoes-float-btn';
                missoesFloatBtn.style.position = 'fixed';
                missoesFloatBtn.style.bottom = '20px';
                missoesFloatBtn.style.right = '20px';
                missoesFloatBtn.style.width = '60px';
                missoesFloatBtn.style.height = '60px';
                missoesFloatBtn.style.borderRadius = '50%';
                missoesFloatBtn.style.background = '#3498db';
                missoesFloatBtn.style.color = '#fff';
                missoesFloatBtn.style.border = '2px solid #2980b9';
                missoesFloatBtn.style.fontSize = '24px';
                missoesFloatBtn.style.cursor = 'pointer';
                missoesFloatBtn.style.boxShadow = '0 4px 12px rgba(0,0,0,0.4)';
                missoesFloatBtn.style.zIndex = '100';
                missoesFloatBtn.style.display = 'flex';
                missoesFloatBtn.style.flexDirection = 'column';
                missoesFloatBtn.style.alignItems = 'center';
                missoesFloatBtn.style.justifyContent = 'center';
                missoesFloatBtn.style.lineHeight = '1';
                missoesFloatBtn.style.transition = 'transform 0.2s, box-shadow 0.2s';
                missoesFloatBtn.innerHTML = `🎯<br><span style="font-size:11px;">${getCompletedCount()}/27</span>`;
                missoesFloatBtn.onmouseover = () => {
                    missoesFloatBtn.style.transform = 'scale(1.1)';
                    missoesFloatBtn.style.boxShadow = '0 6px 16px rgba(0,0,0,0.5)';
                };
                missoesFloatBtn.onmouseout = () => {
                    missoesFloatBtn.style.transform = 'scale(1)';
                    missoesFloatBtn.style.boxShadow = '0 4px 12px rgba(0,0,0,0.4)';
                };
                missoesFloatBtn.onclick = () => {
                    console.debug('[MISSÕES] Clique no botão flutuante. Popup aberto?', missoesPopupOpen);
                    if (missoesPopupOpen) {
                        missaoModoAtivo = false;
                        closeMissoesPopup();
                    } else {
                        // Verifica se há missões incompletas
                        const nextMissao = getNextMissao();
                        console.debug('[MISSÕES] Próxima missão disponível:', nextMissao);
                        if (!nextMissao) {
                            // Tudo completo: mostra lista completa para permitir reset
                            console.debug('[MISSÕES] Tudo completo! Abrindo lista completa...');
                            missoesPopupOpen = true;
                            renderMissoesListaCompleta();
                        } else {
                            // Há missões pendentes: inicia modo ativo
                            console.debug('[MISSÕES] Iniciando missão:', nextMissao.nome);
                            ativarMissao();
                        }
                    }
                };
                document.body.appendChild(missoesFloatBtn);

                // Hooks para verificação de missões (só ativa se modo missão estiver ativo)
                // Edifícios/Monumentos: ao abrir infobox/modal
                const originalShowInfobox = showInfobox;
                showInfobox = function(id) {
                    originalShowInfobox(id);
                    verificarMissaoClique('edificio', id, null);
                    verificarMissaoClique('monumento', id, null);
                };

                const originalShowModelViewerModal = showModelViewerModal;
                showModelViewerModal = function(id, uri, title, description, images) {
                    originalShowModelViewerModal(id, uri, title, description, images);
                    verificarMissaoClique('edificio', id, null);
                    verificarMissaoClique('monumento', id, null);
                };

                // Lendas: ao abrir infobox de lenda
                const originalShowLendaInfobox = showLendaInfobox;
                showLendaInfobox = function(idx) {
                    originalShowLendaInfobox(idx);
                    verificarMissaoClique('lenda', null, idx);
                };

                // Marechais: ao abrir carrossel
                const originalShowMarechaisCarousel = showMarechaisCarousel;
                showMarechaisCarousel = function(startIndex) {
                    originalShowMarechaisCarousel(startIndex);
                    verificarMissaoClique('marechal', null, startIndex || 0);
                };

                // Prefeitos: ao abrir carrossel
                const originalShowPrefeitosCarousel = showPrefeitosCarousel;
                showPrefeitosCarousel = function(startIndex) {
                    originalShowPrefeitosCarousel(startIndex);
                    verificarMissaoClique('prefeito', null, startIndex || 0);
                };

                // Homens Ilustres: ao abrir carrossel
                const originalShowIlustresCarousel = showIlustresCarousel;
                showIlustresCarousel = function(startIndex) {
                    originalShowIlustresCarousel(startIndex);
                    verificarMissaoClique('ilustre', null, startIndex || 0);
                };

                // Nota: Turismo já tem verificação direta no handler de clique (linha ~1520)

                console.debug('[MISSÕES] Sistema de Missão Ativa inicializado com', missoesCulturais.length, 'missões. Progresso:', getCompletedCount(), '/', missoesCulturais.length);

                // ==================== FIM SISTEMA DE MISSÕES ====================

            } catch (error) {
                console.error('Erro na inicialização:', error);
            }
        }

        init();
    </script>
</body>

</html>
